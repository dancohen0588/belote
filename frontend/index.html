<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Belote Suresnes ‚Äî Club de Belote</title>
    <style>
        /* ==========================================================================
           RESET & BASE
           ========================================================================== */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            /* Palette */
            --green-felt: #1a5f4a;
            --green-felt-light: #2a7a60;
            --green-felt-dark: #134a3a;
            --cream: #faf8f5;
            --cream-dark: #f0ede8;
            --gold: #d4a853;
            --gold-light: #e8c078;
            --red-card: #c41e3a;
            --black-card: #1a1a2e;
            --gray-100: #f7f7f7;
            --gray-200: #e8e8e8;
            --gray-300: #d1d1d1;
            --gray-400: #9a9a9a;
            --gray-600: #555;
            --gray-800: #2d2d2d;
            --success: #2ecc71;
            --danger: #e74c3c;

            /* Typography */
            --font-display: 'Georgia', serif;
            --font-body: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;

            /* Spacing */
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;
            --space-2xl: 3rem;
            --space-3xl: 4rem;

            /* Border radius */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;

            /* Shadows */
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);

            /* Transitions */
            --transition-fast: 150ms ease;
            --transition-normal: 250ms ease;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-body);
            background: var(--cream);
            color: var(--gray-800);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* ==========================================================================
           LAYOUT
           ========================================================================== */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 var(--space-lg);
        }

        section {
            padding: var(--space-3xl) 0;
        }

        section:nth-child(even) {
            background: var(--cream-dark);
        }

        /* ==========================================================================
           HEADER
           ========================================================================== */
        header {
            background: linear-gradient(135deg, var(--green-felt-dark) 0%, var(--green-felt) 50%, var(--green-felt-light) 100%);
            color: var(--cream);
            padding: var(--space-xl) 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-lg);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--space-lg);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: var(--cream);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .logo h1 {
            font-family: var(--font-display);
            font-size: 1.75rem;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .logo .subtitle {
            font-size: 0.8rem;
            opacity: 0.8;
            font-weight: 400;
            margin-top: 2px;
        }

        nav ul {
            display: flex;
            list-style: none;
            gap: var(--space-xs);
        }

        nav a {
            color: var(--cream);
            text-decoration: none;
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            font-weight: 500;
            transition: background var(--transition-fast);
        }

        nav a:hover {
            background: rgba(255,255,255,0.15);
        }

        /* ==========================================================================
           TYPOGRAPHY
           ========================================================================== */
        .section-title {
            font-family: var(--font-display);
            font-size: 2rem;
            color: var(--green-felt-dark);
            margin-bottom: var(--space-sm);
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 1.5em;
            background: var(--gold);
            border-radius: 2px;
        }

        .section-subtitle {
            color: var(--gray-400);
            margin-bottom: var(--space-xl);
            font-size: 0.95rem;
        }

        /* ==========================================================================
           BUTTONS
           ========================================================================== */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-sm) var(--space-lg);
            border: none;
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            text-decoration: none;
        }

        .btn-primary {
            background: var(--green-felt);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--green-felt-dark);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--cream);
            color: var(--gray-800);
            border: 1px solid var(--gray-300);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--gray-100);
            border-color: var(--gray-400);
        }

        .btn-gold {
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-light) 100%);
            color: var(--gray-800);
        }

        .btn-gold:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-sm {
            padding: var(--space-xs) var(--space-md);
            font-size: 0.8rem;
        }

        /* ==========================================================================
           SEARCH & FILTERS
           ========================================================================== */
        .search-bar {
            position: relative;
            max-width: 320px;
        }

        .search-bar input {
            width: 100%;
            padding: var(--space-sm) var(--space-md);
            padding-left: 2.5rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            background: white;
            transition: all var(--transition-fast);
        }

        .search-bar input:focus {
            outline: none;
            border-color: var(--green-felt);
            box-shadow: 0 0 0 3px rgba(26, 95, 74, 0.1);
        }

        .search-bar::before {
            content: 'üîç';
            position: absolute;
            left: var(--space-md);
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.9rem;
            opacity: 0.5;
        }

        .filter-bar {
            display: flex;
            gap: var(--space-md);
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-bar select {
            padding: var(--space-sm) var(--space-md);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            background: white;
            cursor: pointer;
            min-width: 180px;
        }

        .filter-bar select:focus {
            outline: none;
            border-color: var(--green-felt);
        }

        /* ==========================================================================
           TABLES
           ========================================================================== */
        .table-wrapper {
            overflow-x: auto;
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: var(--space-md) var(--space-lg);
            text-align: left;
        }

        th {
            background: var(--gray-100);
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            color: var(--gray-600);
            cursor: pointer;
            user-select: none;
            transition: background var(--transition-fast);
            white-space: nowrap;
        }

        th:hover {
            background: var(--gray-200);
        }

        th.sorted-asc::after,
        th.sorted-desc::after {
            margin-left: var(--space-sm);
            opacity: 0.6;
        }

        th.sorted-asc::after {
            content: '‚Üë';
        }

        th.sorted-desc::after {
            content: '‚Üì';
        }

        tbody tr {
            border-bottom: 1px solid var(--gray-200);
            transition: background var(--transition-fast);
        }

        tbody tr:nth-child(even) {
            background: var(--gray-100);
        }

        tbody tr:hover {
            background: rgba(26, 95, 74, 0.05);
        }

        tbody tr:last-child {
            border-bottom: none;
        }

        td {
            font-size: 0.95rem;
        }

        .table-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-lg);
            flex-wrap: wrap;
            gap: var(--space-md);
        }

        /* ==========================================================================
           CARDS
           ========================================================================== */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: var(--space-xl);
        }

        .card {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .card-session {
            border-left: 4px solid var(--gold);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-sm);
            gap: var(--space-sm);
        }

        .card-date {
            font-family: var(--font-display);
            font-size: 1rem;
            color: var(--green-felt-dark);
            font-weight: 600;
        }

        .card-time {
            font-size: 0.85rem;
            color: var(--gray-400);
            margin-top: 2px;
        }

        .card-badge {
            background: var(--green-felt);
            color: white;
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .card-location {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            color: var(--gray-600);
            font-size: 0.85rem;
            margin-bottom: var(--space-sm);
        }

        .card-participants {
            margin-bottom: var(--space-md);
        }

        .card-participants-label {
            font-size: 0.8rem;
            color: var(--gray-400);
            text-transform: uppercase;
            letter-spacing: 0.03em;
            margin-bottom: var(--space-sm);
        }

        .participants-list {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-sm);
        }

        .participant-tag {
            background: var(--cream);
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
            color: var(--gray-800);
        }

        .card-actions {
            display: flex;
            gap: var(--space-sm);
            flex-wrap: wrap;
        }

        .card-match .btn {
            font-size: 0.8rem;
            padding: 0.35rem 0.7rem;
            line-height: 1.1;
        }

        .card-match .card-actions {
            margin-top: var(--space-sm);
        }

        /* ==========================================================================
           KPI CARDS
           ========================================================================== */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--space-xl);
        }

        .kpi-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--green-felt) 0%, var(--gold) 100%);
        }

        .kpi-title {
            font-size: 0.85rem;
            color: var(--gray-400);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: var(--space-md);
        }

        .kpi-value {
            font-family: var(--font-display);
            font-size: 2rem;
            color: var(--green-felt-dark);
            margin-bottom: var(--space-sm);
        }

        .kpi-subtitle {
            font-size: 0.9rem;
            color: var(--gray-600);
        }

        /* Top 3 styling */
        .top-players {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        .top-player {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            padding: var(--space-sm) 0;
        }

        .top-player:not(:last-child) {
            border-bottom: 1px solid var(--gray-200);
            padding-bottom: var(--space-md);
        }

        .rank {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .rank-1 {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4a 100%);
            color: #8b6914;
        }

        .rank-2 {
            background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%);
            color: #666;
        }

        .rank-3 {
            background: linear-gradient(135deg, #cd7f32 0%, #daa06d 100%);
            color: #5c3a1e;
        }

        .player-info {
            flex: 1;
        }

        .player-name {
            font-weight: 600;
            color: var(--gray-800);
        }

        .player-stats {
            font-size: 0.85rem;
            color: var(--gray-400);
        }

        /* Form r√©cente */
        .form-indicator {
            display: flex;
            gap: 4px;
            margin-top: var(--space-sm);
        }

        .form-dot {
            width: 24px;
            height: 24px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
            color: white;
        }

        .form-win {
            background: var(--success);
        }

        .form-loss {
            background: var(--danger);
        }

        /* ==========================================================================
           SCORE TABLE SPECIFICS
           ========================================================================== */
        .team-cell {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .team-players {
            font-weight: 500;
        }

        .score-cell {
            font-family: var(--font-display);
            font-size: 1.1rem;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: var(--radius-sm);
        }

        .score-winner {
            color: var(--success);
            background: rgba(46, 204, 113, 0.12);
        }

        .score-loser {
            color: var(--gray-400);
        }

        .winner-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
            background: rgba(46, 204, 113, 0.1);
            color: var(--success);
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            font-weight: 600;
        }

        .winner-badge.tie {
            background: rgba(212, 168, 83, 0.15);
            color: var(--gold);
        }

        .rounds-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
            background: rgba(26, 95, 74, 0.08);
            color: var(--green-felt-dark);
            padding: 2px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            font-weight: 600;
        }

        .pagination {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: var(--space-sm);
            margin-top: var(--space-md);
            flex-wrap: wrap;
        }

        .pagination-label {
            font-size: 0.85rem;
            color: var(--gray-600);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-scheduled {
            background: rgba(212, 168, 83, 0.15);
            color: var(--gold);
        }

        .status-played {
            background: rgba(46, 204, 113, 0.12);
            color: var(--success);
        }

        .card-match {
            border-left: 4px solid var(--green-felt);
        }

        .match-teams {
            display: grid;
            gap: 4px;
            margin-bottom: var(--space-sm);
        }

        .match-team {
            font-weight: 600;
            color: var(--gray-800);
            font-size: 0.95rem;
        }

        .match-kpis {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: var(--space-sm);
            margin-bottom: var(--space-sm);
        }

        .match-kpi {
            background: var(--gray-100);
            padding: 0.4rem 0.6rem;
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            color: var(--gray-600);
        }

        .match-kpi strong {
            display: block;
            font-family: var(--font-display);
            font-size: 0.95rem;
            color: var(--green-felt-dark);
        }

        .scores-grid {
            display: grid;
            gap: var(--space-md);
        }

        .scores-summary {
            background: var(--gray-100);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-md);
            display: grid;
            gap: var(--space-xs);
            font-size: 0.9rem;
            color: var(--gray-600);
        }

        .scores-summary strong {
            color: var(--green-felt-dark);
        }

        .rounds-row {
            display: grid;
            grid-template-columns: 80px 1fr 1fr;
            gap: var(--space-md);
            align-items: center;
        }

        .round-index {
            font-weight: 600;
            color: var(--green-felt-dark);
        }

        .rounds-actions {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .helper-text {
            font-size: 0.85rem;
            color: var(--gray-400);
        }

        /* ==========================================================================
           EMPTY STATES
           ========================================================================== */
        .empty-state {
            text-align: center;
            padding: var(--space-3xl);
            color: var(--gray-400);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: var(--space-md);
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 1rem;
        }

        /* ==========================================================================
           UTILITIES
           ========================================================================== */
        .win-rate {
            font-weight: 600;
        }

        .win-rate-high {
            color: var(--success);
        }

        .win-rate-medium {
            color: var(--gold);
        }

        .win-rate-low {
            color: var(--danger);
        }

        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .mb-0 {
            margin-bottom: 0;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: var(--space-xl);
            right: var(--space-xl);
            background: var(--gray-800);
            color: white;
            padding: var(--space-md) var(--space-xl);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            transform: translateY(100px);
            opacity: 0;
            transition: all var(--transition-normal);
            z-index: 1000;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        /* Modal */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity var(--transition-normal);
            z-index: 999;
        }

        .modal-backdrop.show {
            opacity: 1;
            pointer-events: auto;
        }

        .modal {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            width: min(560px, 92vw);
            padding: var(--space-xl);
            transform: translateY(12px);
            transition: transform var(--transition-normal);
        }

        .modal-backdrop.show .modal {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-lg);
        }

        .modal-title {
            font-family: var(--font-display);
            font-size: 1.3rem;
            color: var(--green-felt-dark);
        }

        .modal-body {
            display: grid;
            gap: var(--space-md);
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
        }

        .form-group label {
            font-size: 0.85rem;
            color: var(--gray-600);
        }

        .form-group input,
        .form-group select {
            padding: var(--space-sm) var(--space-md);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            font-size: 0.95rem;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--green-felt);
            box-shadow: 0 0 0 3px rgba(26, 95, 74, 0.1);
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: var(--space-sm);
            margin-top: var(--space-lg);
        }

        .icon-btn {
            border: none;
            background: transparent;
            cursor: pointer;
            padding: var(--space-xs);
            border-radius: var(--radius-sm);
            transition: background var(--transition-fast);
        }

        .icon-btn:hover {
            background: var(--gray-100);
        }

        .actions-cell {
            text-align: right;
            white-space: nowrap;
        }

        .clickable-row {
            cursor: pointer;
        }

        /* ==========================================================================
           RESPONSIVE
           ========================================================================== */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }

            nav ul {
                flex-wrap: wrap;
                justify-content: center;
            }

            .section-title {
                font-size: 1.5rem;
            }

            .table-actions {
                flex-direction: column;
                align-items: stretch;
            }

            .search-bar {
                max-width: 100%;
            }

            th, td {
                padding: var(--space-sm) var(--space-md);
            }

            .cards-grid {
                grid-template-columns: 1fr;
            }

            .kpi-grid {
                grid-template-columns: 1fr;
            }

            .filter-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-bar select {
                width: 100%;
            }
        }

        /* ==========================================================================
           DECORATIVE ELEMENTS
           ========================================================================== */
        .card-suit {
            position: absolute;
            font-size: 6rem;
            opacity: 0.03;
            right: -10px;
            bottom: -20px;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <!-- ===== HEADER ===== -->
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">‚ô†</div>
                    <div>
                        <h1>Belote Suresnes</h1>
                        <div class="subtitle">Scores, sessions & performances du club</div>
                    </div>
                </div>
                <nav>
                    <ul>
                        <li><a href="#joueurs">Joueurs</a></li>
                        <li><a href="#parties">Parties</a></li>
                        <li><a href="#sessions">Sessions</a></li>
                        <li><a href="#scores">Scores</a></li>
                        <li><a href="#kpi">KPI</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <!-- ===== SECTION JOUEURS ===== -->
    <section id="joueurs">
        <div class="container">
            <h2 class="section-title">Joueurs</h2>
            <p class="section-subtitle">Les membres du club et leurs statistiques</p>

            <div class="table-actions">
                <div class="search-bar">
                    <input type="text" id="searchPlayers" placeholder="Rechercher un joueur...">
                </div>
                <button class="btn btn-primary" id="addPlayerBtn">
                    <span>+</span> Ajouter un joueur
                </button>
            </div>

            <div class="table-wrapper">
                <table id="playersTable">
                    <thead>
                        <tr>
                            <th data-sort="name">Joueur</th>
                            <th data-sort="games" class="text-center">Parties</th>
                            <th data-sort="wins" class="text-center">Victoires</th>
                            <th data-sort="winRate" class="text-center">Taux</th>
                            <th data-sort="avgPoints" class="text-center">Pts moy.</th>
                            <th class="text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="playersBody">
                        <!-- Rempli dynamiquement -->
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- ===== SECTION PARTIES ===== -->
    <section id="parties">
        <div class="container">
            <h2 class="section-title">Parties</h2>
            <p class="section-subtitle">Planifiez une partie, saisissez les manches et suivez les vainqueurs</p>

            <div class="table-actions mb-0">
                <div></div>
                <button class="btn btn-primary" id="addMatchBtn">
                    <span>+</span> Ajouter une partie
                </button>
            </div>

            <div class="cards-grid" id="matchesGrid">
                <!-- Rempli dynamiquement -->
            </div>

            <div class="empty-state" id="matchesEmpty" style="display: none;">
                <div class="empty-state-icon">‚ô£Ô∏è</div>
                <div class="empty-state-text">Aucune partie planifi√©e pour le moment</div>
            </div>
        </div>
    </section>

    <!-- ===== SECTION HISTORIQUE & SCORES ===== -->
    <section id="scores">
        <div class="container">
            <h2 class="section-title">Historique & scores</h2>
            <p class="section-subtitle">Toutes les parties pass√©es et leurs r√©sultats</p>

            <div class="table-actions">
                <div class="filter-bar">
                    <select id="playerFilter">
                        <option value="">Tous les joueurs</option>
                        <!-- Options remplies dynamiquement -->
                    </select>
                </div>
            </div>

            <div class="table-wrapper">
                <table id="scoresTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>√âquipe A</th>
                            <th class="text-center">Score A</th>
                            <th>√âquipe B</th>
                            <th class="text-center">Score B</th>
                            <th>Vainqueur</th>
                        </tr>
                    </thead>
                    <tbody id="scoresBody">
                        <!-- Rempli dynamiquement -->
                    </tbody>
                </table>
            </div>

            <div class="pagination" id="scoresPagination" style="display: none;">
                <span class="pagination-label" id="scoresPaginationLabel"></span>
                <button class="btn btn-secondary btn-sm" id="scoresPrevBtn">Pr√©c√©dent</button>
                <button class="btn btn-secondary btn-sm" id="scoresNextBtn">Suivant</button>
            </div>

            <div class="empty-state" id="scoresEmpty" style="display: none;">
                <div class="empty-state-icon">üÉè</div>
                <div class="empty-state-text">Aucune partie trouv√©e pour ce joueur</div>
            </div>
        </div>
    </section>

    <!-- ===== SECTION KPI ===== -->
    <section id="kpi">
        <div class="container">
            <h2 class="section-title">KPI & Performances</h2>
            <p class="section-subtitle">Les chiffres cl√©s et les meilleurs joueurs</p>

            <div class="kpi-grid" id="kpiGrid">
                <!-- Rempli dynamiquement -->
            </div>
        </div>
    </section>

    <!-- Toast notification -->
    <div class="toast" id="toast"></div>

    <!-- Modal Joueur -->
    <div class="modal-backdrop" id="playerModal">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="playerModalTitle">
            <div class="modal-header">
                <div class="modal-title" id="playerModalTitle">Ajouter un joueur</div>
                <button class="icon-btn" id="closeModalBtn" aria-label="Fermer">‚úñ</button>
            </div>
            <form id="playerForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="firstName">Pr√©nom *</label>
                        <input type="text" id="firstName" name="first_name" required>
                    </div>
                    <div class="form-group">
                        <label for="lastName">Nom *</label>
                        <input type="text" id="lastName" name="last_name" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email">
                    </div>
                    <div class="form-group">
                        <label for="phone">T√©l√©phone</label>
                        <input type="tel" id="phone" name="phone">
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelModalBtn">Annuler</button>
                    <button type="submit" class="btn btn-primary" id="savePlayerBtn">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Partie -->
    <div class="modal-backdrop" id="matchModal">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="matchModalTitle">
            <div class="modal-header">
                <div class="modal-title" id="matchModalTitle">Ajouter une partie</div>
                <button class="icon-btn" id="closeMatchModalBtn" aria-label="Fermer">‚úñ</button>
            </div>
            <form id="matchForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="matchPlayedAt">Date & heure *</label>
                        <input type="datetime-local" id="matchPlayedAt" name="played_at" required>
                    </div>
                    <div class="form-group">
                        <label for="matchLocation">Lieu *</label>
                        <input type="text" id="matchLocation" name="location" required>
                    </div>
                    <div class="form-group">
                        <label for="team1Player1">√âquipe 1 ‚Äî Joueur 1 *</label>
                        <select id="team1Player1" class="match-player-select" required></select>
                    </div>
                    <div class="form-group">
                        <label for="team1Player2">√âquipe 1 ‚Äî Joueur 2 *</label>
                        <select id="team1Player2" class="match-player-select" required></select>
                    </div>
                    <div class="form-group">
                        <label for="team2Player1">√âquipe 2 ‚Äî Joueur 1 *</label>
                        <select id="team2Player1" class="match-player-select" required></select>
                    </div>
                    <div class="form-group">
                        <label for="team2Player2">√âquipe 2 ‚Äî Joueur 2 *</label>
                        <select id="team2Player2" class="match-player-select" required></select>
                    </div>
                    <div class="helper-text">Les joueurs doivent √™tre tous diff√©rents.</div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelMatchModalBtn">Annuler</button>
                    <button type="submit" class="btn btn-primary" id="saveMatchBtn">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Scores -->
    <div class="modal-backdrop" id="scoresModal">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="scoresModalTitle">
            <div class="modal-header">
                <div class="modal-title" id="scoresModalTitle">Saisir les scores</div>
                <button class="icon-btn" id="closeScoresModalBtn" aria-label="Fermer">‚úñ</button>
            </div>
            <form id="scoresForm">
                <div class="modal-body">
                    <div class="helper-text" id="scoresTeams"></div>
                    <div class="scores-summary" id="scoresSummary" style="display: none;"></div>
                    <div class="form-group">
                        <label for="roundsCount">Nombre de manches *</label>
                        <div class="rounds-actions">
                            <input type="number" id="roundsCount" min="1" value="1">
                            <button type="button" class="btn btn-secondary btn-sm" id="addRoundBtn">+ Manche</button>
                            <button type="button" class="btn btn-secondary btn-sm" id="removeRoundBtn">- Manche</button>
                        </div>
                    </div>
                    <div class="scores-grid" id="roundsContainer">
                        <!-- Lignes de manches -->
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelScoresModalBtn">Annuler</button>
                    <button type="submit" class="btn btn-primary" id="saveScoresBtn">Enregistrer les scores</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ==========================================================================
        // DONN√âES & API
        // ==========================================================================

        const API_BASE = 'http://localhost:3000/api/players';
        const MATCHES_API_BASE = 'http://localhost:3000/api/matches';
        let players = [];
        let matches = [];
        let scoresState = {
            items: [],
            limit: 10,
            offset: 0,
            total: 0,
            filterPlayerId: null
        };

        /**
         * Sessions pass√©es avec scores
         * teamA et teamB contiennent les IDs des joueurs
         * scoreA et scoreB sont les scores finaux
         */
        const pastSessions = [
            {
                id: 1,
                date: "2025-01-25",
                teamA: [1, 2],
                teamB: [3, 4],
                scoreA: 1020,
                scoreB: 890
            },
            {
                id: 2,
                date: "2025-01-18",
                teamA: [5, 6],
                teamB: [7, 8],
                scoreA: 750,
                scoreB: 1150
            },
            {
                id: 3,
                date: "2025-01-11",
                teamA: [9, 10],
                teamB: [11, 12],
                scoreA: 980,
                scoreB: 920
            },
            {
                id: 4,
                date: "2025-01-04",
                teamA: [1, 5],
                teamB: [2, 6],
                scoreA: 1100,
                scoreB: 850
            },
            {
                id: 5,
                date: "2024-12-28",
                teamA: [3, 7],
                teamB: [4, 8],
                scoreA: 890,
                scoreB: 1050
            },
            {
                id: 6,
                date: "2024-12-21",
                teamA: [9, 1],
                teamB: [10, 2],
                scoreA: 1200,
                scoreB: 780
            },
            {
                id: 7,
                date: "2024-12-14",
                teamA: [11, 3],
                teamB: [12, 4],
                scoreA: 950,
                scoreB: 1080
            },
            {
                id: 8,
                date: "2024-12-07",
                teamA: [5, 9],
                teamB: [6, 10],
                scoreA: 1010,
                scoreB: 990
            }
        ];

        /**
         * Sessions √† venir
         * participants contient les IDs des joueurs inscrits
         */
        const upcomingSessions = [
            {
                id: 101,
                date: "2025-02-01",
                time: "20:00",
                location: "Caf√© du Commerce, Suresnes",
                participants: [1, 2, 3, 4, 5, 6]
            },
            {
                id: 102,
                date: "2025-02-08",
                time: "19:30",
                location: "Chez Jean-Pierre",
                participants: [1, 7, 8, 9]
            },
            {
                id: 103,
                date: "2025-02-15",
                time: "20:00",
                location: "Salle municipale",
                participants: [2, 4, 10, 11, 12]
            }
        ];

        // ==========================================================================
        // FONCTIONS UTILITAIRES
        // ==========================================================================

        /**
         * R√©cup√®re un joueur par son ID
         */
        function getPlayerById(id) {
            return players.find(p => p.id === id) || { id, name: `Joueur #${id}` };
        }

        /**
         * Retourne le nom d'affichage d'un joueur (pseudo si disponible, sinon pr√©nom)
         */
        function getDisplayName(player) {
            if (!player) return 'Joueur inconnu';
            if (player.pseudo) return player.pseudo;
            if (player.name) return player.name.split(' ')[0];
            if (player.first_name || player.last_name) {
                return `${player.first_name || ''} ${player.last_name || ''}`.trim();
            }
            return `Joueur #${player.id}`;
        }

        /**
         * Formate une date au format fran√ßais
         */
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const options = { weekday: 'long', day: 'numeric', month: 'long' };
            return date.toLocaleDateString('fr-FR', options);
        }

        /**
         * Formate une date courte
         */
        function formatDateShort(dateStr) {
            const date = new Date(dateStr);
            const options = { day: 'numeric', month: 'short', year: 'numeric' };
            return date.toLocaleDateString('fr-FR', options);
        }

        function formatDateTime(dateStr) {
            const date = new Date(dateStr);
            const options = { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' };
            return date.toLocaleDateString('fr-FR', options);
        }

        function toLocalInputValue(dateStr) {
            const date = dateStr ? new Date(dateStr) : new Date();
            const tzOffset = date.getTimezoneOffset() * 60000;
            return new Date(date.getTime() - tzOffset).toISOString().slice(0, 16);
        }

        /**
         * Calcule les statistiques d'un joueur
         */
        function calculatePlayerStats(playerId) {
            let games = 0;
            let wins = 0;
            let totalPoints = 0;
            const recentResults = [];

            pastSessions.forEach(session => {
                const inTeamA = session.teamA.includes(playerId);
                const inTeamB = session.teamB.includes(playerId);

                if (inTeamA || inTeamB) {
                    games++;
                    const playerPoints = inTeamA ? session.scoreA : session.scoreB;
                    const opponentPoints = inTeamA ? session.scoreB : session.scoreA;
                    totalPoints += playerPoints;

                    const won = playerPoints > opponentPoints;
                    if (won) wins++;

                    // Garder les 5 derniers r√©sultats
                    if (recentResults.length < 5) {
                        recentResults.push(won ? 'W' : 'L');
                    }
                }
            });

            return {
                games,
                wins,
                winRate: games > 0 ? Math.round((wins / games) * 100) : 0,
                avgPoints: games > 0 ? Math.round(totalPoints / games) : 0,
                recentResults
            };
        }

        /**
         * Retourne la classe CSS pour le taux de victoire
         */
        function getWinRateClass(rate) {
            if (rate >= 60) return 'win-rate-high';
            if (rate >= 40) return 'win-rate-medium';
            return 'win-rate-low';
        }

        /**
         * Affiche une notification toast
         */
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function normalizePlayer(row) {
            return {
                ...row,
                name: `${row.first_name} ${row.last_name}`.trim(),
                pseudo: null
            };
        }

        async function fetchPlayers() {
            const response = await fetch(API_BASE);
            const payload = await response.json();

            if (!response.ok || !payload.success) {
                const message = payload?.error?.message || 'Erreur lors du chargement des joueurs.';
                throw new Error(message);
            }

            players = payload.data.map(normalizePlayer);
        }

        async function savePlayer(payload, playerId = null) {
            const method = playerId ? 'PUT' : 'POST';
            const url = playerId ? `${API_BASE}/${playerId}` : API_BASE;

            const response = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await response.json();
            if (!response.ok || !data.success) {
                const message = data?.error?.message || "Erreur lors de l'enregistrement.";
                throw new Error(message);
            }
        }

        async function deletePlayer(playerId) {
            const response = await fetch(`${API_BASE}/${playerId}`, { method: 'DELETE' });
            const data = await response.json();
            if (!response.ok || !data.success) {
                const message = data?.error?.message || 'Erreur lors de la suppression.';
                throw new Error(message);
            }
        }

        async function fetchMatches() {
            const response = await fetch(MATCHES_API_BASE);
            const payload = await response.json();

            if (!response.ok || !payload.success) {
                const message = payload?.error?.message || 'Erreur lors du chargement des parties.';
                throw new Error(message);
            }

            matches = payload.data;
        }

        async function fetchMatchDetails(matchId) {
            const response = await fetch(`${MATCHES_API_BASE}/${matchId}`);
            const payload = await response.json();

            if (!response.ok || !payload.success) {
                const message = payload?.error?.message || 'Erreur lors du chargement de la partie.';
                throw new Error(message);
            }

            return payload.data;
        }

        async function fetchPlayedMatches({ limit = 10, offset = 0, playerId = null } = {}) {
            const params = new URLSearchParams();
            params.set('limit', String(limit));
            params.set('offset', String(offset));
            if (playerId) {
                params.set('player_id', String(playerId));
            }

            const response = await fetch(`${MATCHES_API_BASE}/played?${params.toString()}`);
            const payload = await response.json();

            if (!response.ok || !payload.success) {
                const message = payload?.error?.message || 'Erreur lors du chargement des parties jou√©es.';
                throw new Error(message);
            }

            return payload.data;
        }

        async function saveMatch(payload, matchId = null) {
            const method = matchId ? 'PUT' : 'POST';
            const url = matchId ? `${MATCHES_API_BASE}/${matchId}` : MATCHES_API_BASE;

            const response = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await response.json();
            if (!response.ok || !data.success) {
                const message = data?.error?.message || "Erreur lors de l'enregistrement de la partie.";
                throw new Error(message);
            }
        }

        async function deleteMatch(matchId) {
            const response = await fetch(`${MATCHES_API_BASE}/${matchId}`, { method: 'DELETE' });
            const data = await response.json();
            if (!response.ok || !data.success) {
                const message = data?.error?.message || 'Erreur lors de la suppression.';
                throw new Error(message);
            }
        }

        async function saveMatchRounds(matchId, rounds) {
            const response = await fetch(`${MATCHES_API_BASE}/${matchId}/rounds`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ rounds })
            });
            const data = await response.json();
            if (!response.ok || !data.success) {
                const message = data?.error?.message || 'Erreur lors de la sauvegarde des scores.';
                throw new Error(message);
            }
        }

        // ==========================================================================
        // RENDU DES SECTIONS
        // ==========================================================================

        /**
         * Render la table des joueurs
         */
        function renderPlayersTable(filter = '', sortKey = 'winRate', sortDir = 'desc') {
            const tbody = document.getElementById('playersBody');

            // Calculer les stats pour chaque joueur
            let playersWithStats = players.map(player => {
                const stats = calculatePlayerStats(player.id);
                return {
                    ...player,
                    ...stats
                };
            });

            // Filtrer
            if (filter) {
                const lowerFilter = filter.toLowerCase();
                playersWithStats = playersWithStats.filter(p =>
                    p.name.toLowerCase().includes(lowerFilter) ||
                    (p.pseudo && p.pseudo.toLowerCase().includes(lowerFilter))
                );
            }

            // Trier
            playersWithStats.sort((a, b) => {
                let valA = a[sortKey];
                let valB = b[sortKey];

                if (typeof valA === 'string') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }

                if (sortDir === 'asc') {
                    return valA > valB ? 1 : -1;
                } else {
                    return valA < valB ? 1 : -1;
                }
            });

            if (playersWithStats.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center">Aucun joueur pour le moment.</td>
                    </tr>
                `;
                return;
            }

            // Render
            tbody.innerHTML = playersWithStats.map(player => `
                <tr class="clickable-row" data-player-id="${player.id}">
                    <td>
                        <strong>${player.name}</strong>
                        ${player.pseudo ? `<span style="color: var(--gray-400);"> (${player.pseudo})</span>` : ''}
                    </td>
                    <td class="text-center">${player.games}</td>
                    <td class="text-center">${player.wins}</td>
                    <td class="text-center">
                        <span class="win-rate ${getWinRateClass(player.winRate)}">${player.winRate}%</span>
                    </td>
                    <td class="text-center">${player.avgPoints}</td>
                    <td class="actions-cell">
                        <button class="icon-btn" data-action="edit" title="Modifier">‚úèÔ∏è</button>
                        <button class="icon-btn" data-action="delete" title="Supprimer">üóë</button>
                    </td>
                </tr>
            `).join('');
        }

        function buildMatchWhatsAppMessage(match) {
            const team1Label = getMatchTeamLabel(match.team1);
            const team2Label = getMatchTeamLabel(match.team2);
            const isPlayed = match.status === 'played' || match.rounds_played > 0;

            return `üÉè Belote Suresnes

üìÖ ${formatDateTime(match.played_at)}
üìç ${match.location}
üë• √âquipe 1 : ${team1Label}
üë• √âquipe 2 : ${team2Label}
‚úÖ Statut : ${isPlayed ? 'Jou√©e' : 'Planifi√©e'}`;
        }

        /**
         * Render la table des scores
         */
        function renderScoresTable(filterPlayerId = null) {
            const tbody = document.getElementById('scoresBody');
            const emptyState = document.getElementById('scoresEmpty');
            const tableWrapper = tbody.closest('.table-wrapper');

            const sessions = scoresState.items || [];

            if (sessions.length === 0) {
                tableWrapper.style.display = 'none';
                emptyState.style.display = 'block';
                updateScoresPagination();
                return;
            }

            tableWrapper.style.display = 'block';
            emptyState.style.display = 'none';

            tbody.innerHTML = sessions.map(session => {
                const teamANames = `${getDisplayName(session.teamA.p1)} & ${getDisplayName(session.teamA.p2)}`;
                const teamBNames = `${getDisplayName(session.teamB.p1)} & ${getDisplayName(session.teamB.p2)}`;
                const teamARounds = Number(session.rounds?.wonA) || 0;
                const teamBRounds = Number(session.rounds?.wonB) || 0;
                const isTie = teamARounds === teamBRounds;
                const teamAWins = teamARounds > teamBRounds;
                const winnerNames = isTie ? '√âgalit√©' : (teamAWins ? teamANames : teamBNames);
                const roundSummary = `${teamARounds} - ${teamBRounds}`;

                return `
                    <tr>
                        <td>${formatDateShort(session.played_at)}</td>
                        <td>
                            <div class="team-cell">
                                <span class="team-players">${teamANames}</span>
                            </div>
                        </td>
                        <td class="text-center">
                            <span class="score-cell ${isTie ? '' : (teamAWins ? 'score-winner' : 'score-loser')}">${session.totals?.scoreA ?? 0}</span>
                        </td>
                        <td>
                            <div class="team-cell">
                                <span class="team-players">${teamBNames}</span>
                            </div>
                        </td>
                        <td class="text-center">
                            <span class="score-cell ${isTie ? '' : (!teamAWins ? 'score-winner' : 'score-loser')}">${session.totals?.scoreB ?? 0}</span>
                        </td>
                        <td>
                            <span class="winner-badge ${isTie ? 'tie' : ''}">üèÜ ${winnerNames}</span>
                            <div class="helper-text">Manches : <span class="rounds-badge">${roundSummary}</span></div>
                        </td>
                    </tr>
                `;
            }).join('');
            updateScoresPagination();
        }

        function updateScoresPagination() {
            const pagination = document.getElementById('scoresPagination');
            const label = document.getElementById('scoresPaginationLabel');
            const prevBtn = document.getElementById('scoresPrevBtn');
            const nextBtn = document.getElementById('scoresNextBtn');

            if (!pagination) return;

            const { limit, offset, total } = scoresState;
            const start = total === 0 ? 0 : offset + 1;
            const end = Math.min(offset + limit, total);

            if (total <= limit) {
                pagination.style.display = 'none';
                return;
            }

            pagination.style.display = 'flex';
            label.textContent = `Affichage ${start}-${end} sur ${total}`;
            prevBtn.disabled = offset <= 0;
            nextBtn.disabled = offset + limit >= total;
        }

        async function loadScores() {
            try {
                const data = await fetchPlayedMatches({
                    limit: scoresState.limit,
                    offset: scoresState.offset,
                    playerId: scoresState.filterPlayerId
                });
                scoresState.items = data.items;
                scoresState.total = data.pagination?.total ?? 0;
                scoresState.limit = data.pagination?.limit ?? scoresState.limit;
                scoresState.offset = data.pagination?.offset ?? scoresState.offset;
                renderScoresTable(scoresState.filterPlayerId);
            } catch (error) {
                showToast(error.message || 'Impossible de charger les scores.');
            }
        }

        /**
         * Remplit le dropdown de filtre des joueurs
         */
        function populatePlayerFilter() {
            const select = document.getElementById('playerFilter');
            const sortedPlayers = [...players].sort((a, b) => a.name.localeCompare(b.name));

            while (select.options.length > 1) {
                select.remove(1);
            }

            sortedPlayers.forEach(player => {
                const option = document.createElement('option');
                option.value = player.id;
                option.textContent = `${player.name}${player.pseudo ? ` (${player.pseudo})` : ''}`;
                select.appendChild(option);
            });
        }

        /**
         * Render les KPIs
         */
        function renderKPIs() {
            const grid = document.getElementById('kpiGrid');

            if (players.length === 0) {
                grid.innerHTML = `
                    <div class="kpi-card">
                        <div class="kpi-title">üìä Statistiques du club</div>
                        <div class="kpi-value">0</div>
                        <div class="kpi-subtitle">Aucun joueur enregistr√©</div>
                    </div>
                `;
                return;
            }

            // Calculer les stats pour tous les joueurs
            const allStats = players.map(player => ({
                ...player,
                ...calculatePlayerStats(player.id)
            }));

            // Top 3 (par taux de victoire, puis points moyens)
            const top3 = allStats
                .filter(p => p.games >= 2) // Au moins 2 parties
                .sort((a, b) => {
                    if (b.winRate !== a.winRate) return b.winRate - a.winRate;
                    return b.avgPoints - a.avgPoints;
                })
                .slice(0, 3);

            // Joueur le plus actif
            const mostActive = allStats.reduce((max, p) =>
                p.games > max.games ? p : max
            , allStats[0]);

            // Forme r√©cente du joueur avec le plus de parties r√©centes
            const recentFormPlayer = allStats
                .filter(p => p.recentResults.length >= 3)
                .sort((a, b) => b.games - a.games)[0];

            grid.innerHTML = `
                <!-- Top 3 -->
                <div class="kpi-card">
                    <div class="kpi-title">üèÜ Top 3 joueurs</div>
                    <div class="top-players">
                        ${top3.map((player, index) => `
                            <div class="top-player">
                                <div class="rank rank-${index + 1}">${index + 1}</div>
                                <div class="player-info">
                                    <div class="player-name">${getDisplayName(player)}</div>
                                    <div class="player-stats">${player.winRate}% de victoires ‚Ä¢ ${player.avgPoints} pts/partie</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- Joueur le plus actif -->
                <div class="kpi-card">
                    <div class="kpi-title">üéØ Joueur le plus actif</div>
                    <div class="kpi-value">${getDisplayName(mostActive)}</div>
                    <div class="kpi-subtitle">${mostActive.games} parties jou√©es</div>
                </div>

                <!-- Forme r√©cente -->
                <div class="kpi-card">
                    <div class="kpi-title">üìà Forme r√©cente</div>
                    <div class="kpi-value">${recentFormPlayer ? getDisplayName(recentFormPlayer) : '-'}</div>
                    ${recentFormPlayer ? `
                        <div class="kpi-subtitle">5 derniers r√©sultats :</div>
                        <div class="form-indicator">
                            ${recentFormPlayer.recentResults.map(r => `
                                <span class="form-dot ${r === 'W' ? 'form-win' : 'form-loss'}">${r}</span>
                            `).join('')}
                        </div>
                    ` : '<div class="kpi-subtitle">Pas assez de donn√©es</div>'}
                </div>

                <!-- Stats globales -->
                <div class="kpi-card">
                    <div class="kpi-title">üìä Statistiques du club</div>
                    <div class="kpi-value">${pastSessions.length}</div>
                    <div class="kpi-subtitle">parties jou√©es au total</div>
                    <div style="margin-top: var(--space-md); font-size: 0.9rem; color: var(--gray-600);">
                        ${players.length} joueurs inscrits<br>
                        ${upcomingSessions.length} sessions √† venir
                    </div>
                </div>
            `;
        }

        function getMatchTeamLabel(team) {
            return `${team.p1.name} & ${team.p2.name}`;
        }

        function summarizeRounds(rounds = []) {
            return rounds.reduce((acc, round) => {
                acc.team1 += Number(round.team1_score) || 0;
                acc.team2 += Number(round.team2_score) || 0;
                if ((Number(round.team1_score) || 0) > (Number(round.team2_score) || 0)) {
                    acc.team1Rounds += 1;
                } else if ((Number(round.team2_score) || 0) > (Number(round.team1_score) || 0)) {
                    acc.team2Rounds += 1;
                }
                return acc;
            }, { team1: 0, team2: 0, team1Rounds: 0, team2Rounds: 0 });
        }

        function getWinnerLabelFromTotals(totals, team1Label, team2Label) {
            if (!totals) return '√Ä d√©finir';
            if (totals.team1 > totals.team2) return team1Label;
            if (totals.team2 > totals.team1) return team2Label;
            return '√âgalit√©';
        }

        function updateScoresSummary(totals, team1Label, team2Label) {
            const summary = document.getElementById('scoresSummary');
            if (!summary || !totals) return;
            const winnerLabel = getWinnerLabelFromTotals(totals, team1Label, team2Label);
            summary.style.display = 'grid';
            summary.innerHTML = `
                <div><strong>Vainqueurs :</strong> ${winnerLabel}</div>
                <div><strong>Score cumul√© :</strong> ${totals.team1} - ${totals.team2}</div>
                <div><strong>Manches gagn√©es :</strong> √âquipe 1 ${totals.team1Rounds} ‚Ä¢ √âquipe 2 ${totals.team2Rounds}</div>
            `;
        }

        function renderMatches() {
            const grid = document.getElementById('matchesGrid');
            const emptyState = document.getElementById('matchesEmpty');

            if (!matches.length) {
                grid.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            grid.innerHTML = matches.map(match => {
                const team1Label = getMatchTeamLabel(match.team1);
                const team2Label = getMatchTeamLabel(match.team2);
                const isPlayed = match.status === 'played' || match.rounds_played > 0;
                const totals = match.rounds ? summarizeRounds(match.rounds) : null;
                const hasTotals = totals && (match.rounds || []).length > 0;
                const winnerLabel = hasTotals ? getWinnerLabelFromTotals(totals, team1Label, team2Label) : '√Ä d√©finir';

                return `
                    <div class="card card-match" data-match-id="${match.id}">
                        <span class="card-suit">‚ô†</span>
                        <div class="card-header">
                            <div>
                                <div class="card-date">${formatDateTime(match.played_at)}</div>
                                <div class="card-time">${match.location}</div>
                            </div>
                            <span class="status-badge ${isPlayed ? 'status-played' : 'status-scheduled'}">
                                ${isPlayed ? 'Jou√©e' : 'Planifi√©e'}
                            </span>
                        </div>
                        <div class="match-teams">
                            <div class="match-team">√âquipe 1 : ${team1Label}</div>
                            <div class="match-team">√âquipe 2 : ${team2Label}</div>
                        </div>
                        <div class="match-kpis">
                            <div class="match-kpi">
                                √âquipe gagnante
                                <strong>${isPlayed ? winnerLabel : '‚Äî'}</strong>
                            </div>
                            <div class="match-kpi">
                                Manches
                                <strong>${match.rounds_played}</strong>
                            </div>
                            <div class="match-kpi">
                                Score cumul√©
                                <strong>${hasTotals ? `${totals.team1} - ${totals.team2}` : '‚Äî'}</strong>
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="btn btn-secondary btn-sm" data-action="edit-match">‚úèÔ∏è Modifier</button>
                            <button class="btn btn-secondary btn-sm" data-action="delete-match">üóë Supprimer</button>
                            <button class="btn btn-gold btn-sm" data-action="scores-match">üßÆ Saisir les scores</button>
                            <button class="btn btn-gold btn-sm" data-action="copy-match">üì± Copier message WhatsApp</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ==========================================================================
        // EVENT LISTENERS & INITIALISATION
        // ==========================================================================

        // √âtat du tri
        let currentSort = { key: 'winRate', dir: 'desc' };

        /**
         * Gestion du tri des colonnes
         */
        function setupTableSort() {
            const headers = document.querySelectorAll('#playersTable th[data-sort]');

            headers.forEach(th => {
                th.addEventListener('click', () => {
                    const key = th.dataset.sort;

                    // Inverser la direction si on clique sur la m√™me colonne
                    if (currentSort.key === key) {
                        currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort.key = key;
                        currentSort.dir = 'desc';
                    }

                    // Mettre √† jour les classes CSS
                    headers.forEach(h => h.classList.remove('sorted-asc', 'sorted-desc'));
                    th.classList.add(currentSort.dir === 'asc' ? 'sorted-asc' : 'sorted-desc');

                    // Re-render
                    const filter = document.getElementById('searchPlayers').value;
                    renderPlayersTable(filter, currentSort.key, currentSort.dir);
                });
            });

            // Marquer la colonne par d√©faut
            const defaultTh = document.querySelector('#playersTable th[data-sort="winRate"]');
            if (defaultTh) defaultTh.classList.add('sorted-desc');
        }

        /**
         * Gestion de la recherche de joueurs
         */
        function setupSearch() {
            const searchInput = document.getElementById('searchPlayers');

            searchInput.addEventListener('input', (e) => {
                renderPlayersTable(e.target.value, currentSort.key, currentSort.dir);
            });
        }

        /**
         * Gestion du filtre par joueur dans les scores
         */
        function setupPlayerFilter() {
            const select = document.getElementById('playerFilter');

            select.addEventListener('change', (e) => {
                const playerId = e.target.value ? parseInt(e.target.value) : null;
                scoresState.filterPlayerId = playerId;
                scoresState.offset = 0;
                loadScores();
            });
        }

        function setupScoresPagination() {
            const prevBtn = document.getElementById('scoresPrevBtn');
            const nextBtn = document.getElementById('scoresNextBtn');

            if (!prevBtn || !nextBtn) return;

            prevBtn.addEventListener('click', () => {
                scoresState.offset = Math.max(0, scoresState.offset - scoresState.limit);
                loadScores();
            });

            nextBtn.addEventListener('click', () => {
                const nextOffset = scoresState.offset + scoresState.limit;
                if (nextOffset < scoresState.total) {
                    scoresState.offset = nextOffset;
                    loadScores();
                }
            });
        }

        function setupPlayerActions() {
            const tbody = document.getElementById('playersBody');

            tbody.addEventListener('click', (event) => {
                const editBtn = event.target.closest('[data-action="edit"]');
                const deleteBtn = event.target.closest('[data-action="delete"]');
                const row = event.target.closest('tr[data-player-id]');

                if (editBtn && row) {
                    event.stopPropagation();
                    const playerId = Number(row.dataset.playerId);
                    const player = players.find(p => p.id === playerId);
                    if (player) openPlayerModal('edit', player);
                    return;
                }

                if (deleteBtn && row) {
                    event.stopPropagation();
                    const playerId = Number(row.dataset.playerId);
                    handleDeletePlayer(playerId);
                    return;
                }

                if (row) {
                    const playerId = Number(row.dataset.playerId);
                    const player = players.find(p => p.id === playerId);
                    if (player) openPlayerModal('edit', player);
                }
            });
        }

        function setupModal() {
            const modal = document.getElementById('playerModal');
            const closeBtn = document.getElementById('closeModalBtn');
            const cancelBtn = document.getElementById('cancelModalBtn');
            const form = document.getElementById('playerForm');

            function closeModal() {
                modal.classList.remove('show');
                form.reset();
                form.dataset.mode = '';
                form.dataset.playerId = '';
            }

            window.openPlayerModal = function openPlayerModal(mode, player = null) {
                const title = document.getElementById('playerModalTitle');
                const saveBtn = document.getElementById('savePlayerBtn');

                form.dataset.mode = mode;
                form.dataset.playerId = player ? player.id : '';

                title.textContent = mode === 'edit' ? 'Modifier le joueur' : 'Ajouter un joueur';
                saveBtn.textContent = mode === 'edit' ? 'Enregistrer' : 'Ajouter';

                if (player) {
                    document.getElementById('firstName').value = player.first_name || '';
                    document.getElementById('lastName').value = player.last_name || '';
                    document.getElementById('email').value = player.email || '';
                    document.getElementById('phone').value = player.phone || '';
                }

                modal.classList.add('show');
            };

            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (event) => {
                if (event.target === modal) closeModal();
            });

            form.addEventListener('submit', async (event) => {
                event.preventDefault();

                const payload = {
                    first_name: document.getElementById('firstName').value.trim(),
                    last_name: document.getElementById('lastName').value.trim(),
                    email: document.getElementById('email').value.trim(),
                    phone: document.getElementById('phone').value.trim()
                };

                if (!payload.first_name || !payload.last_name) {
                    showToast('Pr√©nom et nom sont obligatoires.');
                    return;
                }

                if (payload.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(payload.email)) {
                    showToast("Email invalide.");
                    return;
                }

                try {
                    const mode = form.dataset.mode;
                    const playerId = form.dataset.playerId ? Number(form.dataset.playerId) : null;
                    await savePlayer(payload, mode === 'edit' ? playerId : null);
                    await loadPlayers();
                    showToast(mode === 'edit' ? 'Joueur mis √† jour.' : 'Joueur cr√©√©.');
                    closeModal();
                } catch (error) {
                    showToast(error.message || 'Erreur lors de la sauvegarde.');
                }
            });
        }

        async function handleDeletePlayer(playerId) {
            const confirmed = confirm('Supprimer ce joueur ?');
            if (!confirmed) return;

            try {
                await deletePlayer(playerId);
                await loadPlayers();
                showToast('Joueur supprim√©.');
            } catch (error) {
                showToast(error.message || 'Erreur lors de la suppression.');
            }
        }

        async function loadPlayers() {
            try {
                await fetchPlayers();
                const filter = document.getElementById('searchPlayers').value;
                renderPlayersTable(filter, currentSort.key, currentSort.dir);
                populatePlayerFilter();
                renderKPIs();
                populateMatchSelects();
            } catch (error) {
                showToast(error.message || 'Impossible de charger les joueurs.');
            }
        }

        function populateMatchSelects() {
            const selects = document.querySelectorAll('.match-player-select');
            const sortedPlayers = [...players].sort((a, b) => a.name.localeCompare(b.name));

            selects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '';
                const placeholder = document.createElement('option');
                placeholder.value = '';
                placeholder.textContent = 'S√©lectionner un joueur';
                placeholder.disabled = true;
                placeholder.selected = true;
                select.appendChild(placeholder);

                sortedPlayers.forEach(player => {
                    const option = document.createElement('option');
                    option.value = player.id;
                    option.textContent = `${player.name}`;
                    select.appendChild(option);
                });

                if (currentValue) {
                    select.value = currentValue;
                }
            });
        }

        async function loadMatches() {
            try {
                await fetchMatches();

                const playedMatches = matches.filter(match => match.status === 'played' && match.rounds_played > 0);
                const details = await Promise.all(
                    playedMatches.map(match => fetchMatchDetails(match.id).catch(() => null))
                );

                details.forEach(detail => {
                    if (!detail) return;
                    const index = matches.findIndex(match => match.id === detail.id);
                    if (index !== -1) {
                        matches[index] = { ...matches[index], rounds: detail.rounds };
                    }
                });

                renderMatches();
            } catch (error) {
                showToast(error.message || 'Impossible de charger les parties.');
            }
        }

        function setupMatchModal() {
            const modal = document.getElementById('matchModal');
            const closeBtn = document.getElementById('closeMatchModalBtn');
            const cancelBtn = document.getElementById('cancelMatchModalBtn');
            const form = document.getElementById('matchForm');

            function closeModal() {
                modal.classList.remove('show');
                form.reset();
                form.dataset.mode = '';
                form.dataset.matchId = '';
            }

            window.openMatchModal = function openMatchModal(mode, match = null) {
                const title = document.getElementById('matchModalTitle');
                const saveBtn = document.getElementById('saveMatchBtn');

                form.dataset.mode = mode;
                form.dataset.matchId = match ? match.id : '';

                title.textContent = mode === 'edit' ? 'Modifier la partie' : 'Ajouter une partie';
                saveBtn.textContent = mode === 'edit' ? 'Enregistrer' : 'Ajouter';

                populateMatchSelects();

                if (match) {
                    document.getElementById('matchPlayedAt').value = toLocalInputValue(match.played_at);
                    document.getElementById('matchLocation').value = match.location || '';
                    document.getElementById('team1Player1').value = match.team1.p1.id;
                    document.getElementById('team1Player2').value = match.team1.p2.id;
                    document.getElementById('team2Player1').value = match.team2.p1.id;
                    document.getElementById('team2Player2').value = match.team2.p2.id;
                } else {
                    document.getElementById('matchPlayedAt').value = toLocalInputValue();
                }

                modal.classList.add('show');
            };

            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (event) => {
                if (event.target === modal) closeModal();
            });

            form.addEventListener('submit', async (event) => {
                event.preventDefault();

                const payload = {
                    played_at: document.getElementById('matchPlayedAt').value,
                    location: document.getElementById('matchLocation').value.trim(),
                    team1: {
                        p1: document.getElementById('team1Player1').value,
                        p2: document.getElementById('team1Player2').value
                    },
                    team2: {
                        p1: document.getElementById('team2Player1').value,
                        p2: document.getElementById('team2Player2').value
                    }
                };

                const allIds = [payload.team1.p1, payload.team1.p2, payload.team2.p1, payload.team2.p2];
                const uniqueIds = new Set(allIds);

                if (!payload.played_at || !payload.location) {
                    showToast('La date et le lieu sont obligatoires.');
                    return;
                }

                if (uniqueIds.size !== 4) {
                    showToast('Chaque joueur doit √™tre unique dans la partie.');
                    return;
                }

                try {
                    const mode = form.dataset.mode;
                    const matchId = form.dataset.matchId ? Number(form.dataset.matchId) : null;
                    await saveMatch(payload, mode === 'edit' ? matchId : null);
                    await loadMatches();
                    showToast(mode === 'edit' ? 'Partie mise √† jour.' : 'Partie cr√©√©e.');
                    closeModal();
                } catch (error) {
                    showToast(error.message || 'Erreur lors de la sauvegarde.');
                }
            });
        }

        function renderRoundsRows(count, existingRounds = []) {
            const container = document.getElementById('roundsContainer');
            container.innerHTML = '';

            for (let i = 1; i <= count; i += 1) {
                const existing = existingRounds.find(r => Number(r.round_index) === i) || {};
                const row = document.createElement('div');
                row.className = 'rounds-row';
                row.dataset.roundIndex = i;
                row.innerHTML = `
                    <div class="round-index">Manche ${i}</div>
                    <input type="number" min="0" value="${existing.team1_score ?? ''}" placeholder="Score √©quipe 1" required>
                    <input type="number" min="0" value="${existing.team2_score ?? ''}" placeholder="Score √©quipe 2" required>
                `;
                container.appendChild(row);
            }
        }

        function setupScoresModal() {
            const modal = document.getElementById('scoresModal');
            const closeBtn = document.getElementById('closeScoresModalBtn');
            const cancelBtn = document.getElementById('cancelScoresModalBtn');
            const form = document.getElementById('scoresForm');
            const roundsCountInput = document.getElementById('roundsCount');
            const addRoundBtn = document.getElementById('addRoundBtn');
            const removeRoundBtn = document.getElementById('removeRoundBtn');
            const teamsLabel = document.getElementById('scoresTeams');
            const summary = document.getElementById('scoresSummary');

            function closeModal() {
                modal.classList.remove('show');
                form.reset();
                form.dataset.matchId = '';
                teamsLabel.textContent = '';
                summary.style.display = 'none';
                summary.innerHTML = '';
                renderRoundsRows(1);
            }

            window.openScoresModal = function openScoresModal(match) {
                form.dataset.matchId = match.id;
                teamsLabel.textContent = `√âquipe 1 : ${getMatchTeamLabel(match.team1)} | √âquipe 2 : ${getMatchTeamLabel(match.team2)}`;
                roundsCountInput.value = match.rounds_played && match.rounds_played > 0 ? match.rounds_played : 1;
                renderRoundsRows(Number(roundsCountInput.value), match.rounds || []);
                if (match.rounds && match.rounds.length) {
                    const totals = summarizeRounds(match.rounds);
                    updateScoresSummary(totals, getMatchTeamLabel(match.team1), getMatchTeamLabel(match.team2));
                } else {
                    summary.style.display = 'none';
                    summary.innerHTML = '';
                }
                modal.classList.add('show');
            };

            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (event) => {
                if (event.target === modal) closeModal();
            });

            addRoundBtn.addEventListener('click', () => {
                const nextCount = Number(roundsCountInput.value) + 1;
                roundsCountInput.value = nextCount;
                renderRoundsRows(nextCount);
            });

            removeRoundBtn.addEventListener('click', () => {
                const current = Number(roundsCountInput.value) || 1;
                const nextCount = Math.max(1, current - 1);
                roundsCountInput.value = nextCount;
                renderRoundsRows(nextCount);
            });

            roundsCountInput.addEventListener('change', () => {
                const value = Math.max(1, Number(roundsCountInput.value) || 1);
                roundsCountInput.value = value;
                renderRoundsRows(value);
            });

            form.addEventListener('submit', async (event) => {
                event.preventDefault();

                const matchId = Number(form.dataset.matchId);
                const rows = Array.from(document.querySelectorAll('#roundsContainer .rounds-row'));
                const rounds = rows.map((row, index) => {
                    const inputs = row.querySelectorAll('input');
                    return {
                        round_index: index + 1,
                        team1_score: Number(inputs[0].value),
                        team2_score: Number(inputs[1].value)
                    };
                });

                if (rounds.some(round => !Number.isInteger(round.team1_score) || round.team1_score < 0 || !Number.isInteger(round.team2_score) || round.team2_score < 0)) {
                    showToast('Les scores doivent √™tre des entiers positifs.');
                    return;
                }

                try {
                    await saveMatchRounds(matchId, rounds);
                    const updatedMatch = await fetchMatchDetails(matchId);
                    const index = matches.findIndex(match => match.id === matchId);
                    if (index !== -1) {
                        matches[index] = { ...matches[index], ...updatedMatch };
                    }
                    if (updatedMatch.rounds && updatedMatch.rounds.length) {
                        const totals = summarizeRounds(updatedMatch.rounds);
                        updateScoresSummary(totals, getMatchTeamLabel(updatedMatch.team1), getMatchTeamLabel(updatedMatch.team2));
                    }
                    renderMatches();
                    showToast('Scores enregistr√©s.');
                    closeModal();
                } catch (error) {
                    showToast(error.message || 'Erreur lors de la sauvegarde des scores.');
                }
            });
        }

        function setupMatchActions() {
            const grid = document.getElementById('matchesGrid');

            grid.addEventListener('click', (event) => {
                const editBtn = event.target.closest('[data-action="edit-match"]');
                const deleteBtn = event.target.closest('[data-action="delete-match"]');
                const scoresBtn = event.target.closest('[data-action="scores-match"]');
                const copyBtn = event.target.closest('[data-action="copy-match"]');
                const card = event.target.closest('[data-match-id]');

                if (!card) return;
                const matchId = Number(card.dataset.matchId);
                const match = matches.find(item => item.id === matchId);

                if (editBtn && match) {
                    openMatchModal('edit', match);
                    return;
                }

                if (deleteBtn && match) {
                    const confirmed = confirm('Supprimer cette partie ?');
                    if (!confirmed) return;
                    deleteMatch(matchId)
                        .then(() => loadMatches())
                        .then(() => showToast('Partie supprim√©e.'))
                        .catch(error => showToast(error.message || 'Erreur lors de la suppression.'));
                    return;
                }

                if (scoresBtn && match) {
                    openScoresModal(match);
                    return;
                }

                if (copyBtn && match) {
                    const message = buildMatchWhatsAppMessage(match);
                    navigator.clipboard.writeText(message)
                        .then(() => {
                            showToast('Message copi√© ! Collez-le dans WhatsApp üì±');
                        })
                        .catch(() => {
                            showToast('Erreur lors de la copie');
                        });
                }
            });
        }

        /**
         * Initialisation de l'application
         */
        async function init() {
            await loadPlayers();
            await loadMatches();
            await loadScores();

            setupTableSort();
            setupSearch();
            setupPlayerFilter();
            setupScoresPagination();
            setupPlayerActions();
            setupModal();
            setupMatchModal();
            setupScoresModal();
            setupMatchActions();

            document.getElementById('addPlayerBtn').addEventListener('click', () => {
                openPlayerModal('create');
            });

            document.getElementById('addMatchBtn').addEventListener('click', () => {
                openMatchModal('create');
            });
        }

        // Lancer l'application au chargement
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
