<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Belote Suresnes - Club de Belote</title>
    <style>
        :root {
            --bg-deep: #1e3a2f;
            --bg-surface: #2a4f40;
            --bg-card: #345c4a;
            --bg-elevated: #3d6b56;
            --accent: #c9a962;
            --accent-light: #e5d4a1;
            --accent-muted: rgba(201, 169, 98, 0.15);
            --text-primary: #f4f4f2;
            --text-secondary: #c5d4cb;
            --text-muted: #8fa396;
            --red: #e07070;
            --green-success: #6be088;
            --border: rgba(201, 169, 98, 0.12);
            --border-strong: rgba(201, 169, 98, 0.25);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-deep);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* Fond plus clair avec dÃ©gradÃ© subtil */
        .background {
            position: fixed;
            inset: 0;
            z-index: -1;
            background: 
                radial-gradient(ellipse 100% 80% at 50% 0%, var(--bg-surface) 0%, transparent 60%),
                radial-gradient(ellipse 80% 50% at 20% 100%, rgba(201, 169, 98, 0.05) 0%, transparent 50%),
                radial-gradient(ellipse 60% 40% at 90% 80%, rgba(201, 169, 98, 0.03) 0%, transparent 50%),
                var(--bg-deep);
        }

        /* Texture trÃ¨s subtile */
        .background::after {
            content: '';
            position: absolute;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
            opacity: 0.025;
            pointer-events: none;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* Header */
        header {
            padding: 2rem 0 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 42px;
            height: 42px;
            background: var(--accent);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            color: var(--bg-deep);
            font-weight: 700;
        }

        h1 {
            font-family: 'DM Serif Display', serif;
            font-size: 1.75rem;
            font-weight: 400;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        .subtitle {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        /* Navigation STICKY */
        .nav-wrapper {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--bg-deep);
            padding: 0.75rem 0;
            margin: 0 -1.5rem;
            padding-left: 1.5rem;
            padding-right: 1.5rem;
            border-bottom: 1px solid var(--border);
            backdrop-filter: blur(10px);
            background: rgba(30, 58, 47, 0.95);
        }

        nav {
            display: flex;
            gap: 0.25rem;
            background: var(--bg-surface);
            padding: 0.25rem;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            overflow-x: auto;
            max-width: 1100px;
            margin: 0 auto;
        }

        nav a {
            color: var(--text-secondary);
            text-decoration: none;
            padding: 0.6rem 1.25rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: var(--radius-sm);
            transition: all 0.2s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            flex: 1;
            justify-content: center;
        }

        nav a .suit {
            font-size: 0.85rem;
            opacity: 0.6;
        }

        nav a:hover {
            color: var(--text-primary);
            background: var(--bg-card);
        }

        nav a.active {
            background: var(--accent);
            color: var(--bg-deep);
        }

        nav a.active .suit {
            opacity: 1;
        }

        .main-content {
            padding-top: 1rem;
        }

        /* Sections */
        section {
            background: var(--bg-surface);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
            display: none;
        }

        section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.25rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .section-title {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        h2 {
            font-family: 'DM Serif Display', serif;
            font-size: 1.25rem;
            font-weight: 400;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        h2 .suit {
            color: var(--accent);
            font-size: 1rem;
        }

        .section-subtitle {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.6rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: var(--radius-sm);
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--accent);
            color: var(--bg-deep);
        }

        .btn-primary:hover {
            background: var(--accent-light);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-strong);
        }

        .btn-secondary:hover {
            background: var(--bg-elevated);
            border-color: var(--accent);
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-icon:hover {
            background: var(--bg-elevated);
            color: var(--accent);
            border-color: var(--accent);
        }

        /* Players Grid */
        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 1rem;
        }

        .player-card {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 1.25rem;
            border: 1px solid var(--border);
            transition: all 0.25s ease;
            position: relative;
            overflow: hidden;
        }

        .player-card::before {
            content: attr(data-suit);
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            font-size: 1.25rem;
            opacity: 0.15;
            transition: all 0.25s;
        }

        .player-card:hover {
            border-color: var(--border-strong);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
        }

        .player-card:hover::before {
            opacity: 0.3;
            transform: scale(1.1);
        }

        .player-top {
            display: flex;
            align-items: center;
            gap: 0.875rem;
            margin-bottom: 1rem;
        }

        .player-avatar {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: 700;
            color: var(--bg-deep);
            flex-shrink: 0;
        }

        .player-info {
            flex: 1;
            min-width: 0;
        }

        .player-name {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 0.15rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .player-form {
            display: flex;
            gap: 0.2rem;
            font-size: 0.7rem;
        }

        .form-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .form-dot.win { background: var(--green-success); }
        .form-dot.loss { background: var(--red); }

        .player-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value.highlight {
            color: var(--accent);
        }

        /* ========== PARTIES SECTION ========== */
        .parties-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .partie-card {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            overflow: hidden;
            transition: all 0.2s;
        }

        .partie-card:hover {
            border-color: var(--border-strong);
        }

        .partie-card.live {
            border-color: var(--green-success);
            box-shadow: 0 0 0 1px var(--green-success), 0 4px 20px rgba(107, 224, 136, 0.15);
        }

        .partie-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border);
        }

        .partie-meta {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .partie-date {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .partie-lieu {
            font-size: 0.8rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .partie-status {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.3rem 0.6rem;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-planifiee {
            background: var(--accent-muted);
            color: var(--accent);
        }

        .status-en-cours {
            background: rgba(107, 224, 136, 0.15);
            color: var(--green-success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .status-terminee {
            background: rgba(197, 212, 203, 0.15);
            color: var(--text-secondary);
        }

        .partie-body {
            padding: 1.5rem 1.25rem;
        }

        .partie-teams {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 1.5rem;
            align-items: center;
        }

        .team {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .team.right {
            text-align: right;
            align-items: flex-end;
        }

        .team-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .team-players {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .team.right .team-players {
            flex-direction: row-reverse;
        }

        .team-player-avatar {
            width: 36px;
            height: 36px;
            background: var(--bg-elevated);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .team-names {
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* Score principal = Manches gagnÃ©es */
        .vs-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .rounds-score {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .round-score {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'DM Serif Display', serif;
            font-size: 1.75rem;
            font-weight: 400;
            background: var(--bg-surface);
            border: 2px solid var(--border);
            color: var(--text-secondary);
        }

        .round-score.winning {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg-deep);
        }

        .round-score.muted {
            opacity: 0.4;
        }

        .rounds-separator {
            font-size: 1.5rem;
            color: var(--text-muted);
            font-weight: 300;
        }

        .vs-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .total-points {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .total-points span {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .partie-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.875rem 1.25rem;
            background: rgba(0,0,0,0.1);
            border-top: 1px solid var(--border);
        }

        .manches-info {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .manches-dots {
            display: flex;
            gap: 0.3rem;
            margin-top: 0.3rem;
        }

        .manche-dot {
            width: 24px;
            height: 6px;
            border-radius: 3px;
            background: var(--bg-elevated);
        }

        .manche-dot.team-a { background: var(--accent); }
        .manche-dot.team-b { background: var(--text-secondary); }

        .partie-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* ========== SCORES TABLE ========== */
        .scores-table {
            width: 100%;
            border-collapse: collapse;
        }

        .scores-table th {
            text-align: left;
            padding: 0.75rem 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
        }

        .scores-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
        }

        .scores-table tr:hover td {
            background: var(--bg-card);
        }

        .score-cell {
            font-weight: 700;
            font-family: 'DM Serif Display', serif;
            font-size: 1.1rem;
        }

        .score-cell.winner {
            color: var(--accent);
        }

        .winner-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            background: var(--accent-muted);
            color: var(--accent);
            padding: 0.25rem 0.6rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* ========== KPI SECTION ========== */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .kpi-card {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 1.25rem;
            text-align: center;
            border: 1px solid var(--border);
            position: relative;
        }

        .kpi-card .suit-watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4rem;
            opacity: 0.04;
            pointer-events: none;
        }

        .kpi-value {
            font-family: 'DM Serif Display', serif;
            font-size: 2rem;
            color: var(--accent);
            line-height: 1.2;
        }

        .kpi-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 0.25rem;
        }

        /* Top 3 joueurs */
        .kpi-section-title {
            font-family: 'DM Serif Display', serif;
            font-size: 1.1rem;
            color: var(--text-primary);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .podium {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 1rem 0;
        }

        .podium-place {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .podium-avatar {
            width: 56px;
            height: 56px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--bg-deep);
        }

        .podium-place.first .podium-avatar {
            width: 70px;
            height: 70px;
            font-size: 1.3rem;
            background: linear-gradient(135deg, #ffd700 0%, #ffec8b 50%, #daa520 100%);
            box-shadow: 0 4px 20px rgba(255, 215, 0, 0.3);
        }

        .podium-place.second .podium-avatar {
            background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 50%, #a8a8a8 100%);
        }

        .podium-place.third .podium-avatar {
            background: linear-gradient(135deg, #cd7f32 0%, #daa06d 50%, #b87333 100%);
        }

        .podium-rank {
            font-size: 1.5rem;
        }

        .podium-name {
            font-weight: 600;
            font-size: 0.9rem;
            text-align: center;
        }

        .podium-stat {
            font-size: 0.8rem;
            color: var(--accent);
            font-weight: 500;
        }

        .podium-bar {
            width: 80px;
            border-radius: var(--radius-sm) var(--radius-sm) 0 0;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-bottom: none;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 0.5rem;
        }

        .podium-place.first .podium-bar {
            height: 100px;
            background: linear-gradient(180deg, rgba(255, 215, 0, 0.1) 0%, var(--bg-card) 100%);
        }

        .podium-place.second .podium-bar {
            height: 70px;
        }

        .podium-place.third .podium-bar {
            height: 50px;
        }

        /* Meilleur score cumulÃ© */
        .best-score-card {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 1.25rem;
            margin-bottom: 2rem;
        }

        .best-score-icon {
            width: 60px;
            height: 60px;
            background: var(--accent-muted);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
        }

        .best-score-info {
            flex: 1;
        }

        .best-score-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .best-score-value {
            font-family: 'DM Serif Display', serif;
            font-size: 2rem;
            color: var(--accent);
        }

        .best-score-player {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Parties par mois - Chart */
        .chart-container {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            border: 1px solid var(--border);
        }

        .bar-chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            height: 150px;
            gap: 0.5rem;
            padding-top: 1rem;
        }

        .bar-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .bar {
            width: 100%;
            max-width: 40px;
            background: var(--accent);
            border-radius: var(--radius-sm) var(--radius-sm) 0 0;
            transition: all 0.3s ease;
            position: relative;
        }

        .bar:hover {
            background: var(--accent-light);
        }

        .bar-value {
            position: absolute;
            top: -1.5rem;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--accent);
        }

        .bar-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .footer-suits {
            display: flex;
            justify-content: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
            font-size: 1rem;
            opacity: 0.4;
        }

        /* Responsive */
        @media (max-width: 640px) {
            .container { padding: 1rem; }
            h1 { font-size: 1.4rem; }
            .section-header { flex-direction: column; }
            .partie-teams { grid-template-columns: 1fr; gap: 1.5rem; }
            .team, .team.right { text-align: center; align-items: center; }
            .team.right .team-players { flex-direction: row; }
            .vs-container { order: -1; }
            nav a { padding: 0.5rem 0.75rem; font-size: 0.8rem; }
            .podium { flex-direction: column; align-items: center; }
            .podium-place { flex-direction: row; gap: 1rem; }
            .podium-bar { display: none; }
        }
    
        .players-toolbar {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 0.75rem;
            align-items: center;
            margin-bottom: 1rem;
        }

        .search-bar {
            max-width: 360px;
        }

        .search-bar input {
            width: 100%;
            border: 1px solid var(--border-strong);
            background: var(--bg-card);
            color: var(--text-primary);
            border-radius: var(--radius-sm);
            padding: 0.6rem 0.75rem;
        }

        .sort-bar {
            display: flex;
            justify-content: flex-end;
            flex-wrap: wrap;
            gap: 0.3rem;
        }

        .sort-btn {
            border: 1px solid var(--border-strong);
            background: var(--bg-card);
            color: var(--text-secondary);
            border-radius: 999px;
            padding: 0.32rem 0.65rem;
            font-size: 0.74rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .sort-btn.active {
            border-color: var(--accent);
            background: var(--accent-muted);
            color: var(--accent-light);
        }

        .sort-btn.active[data-dir="asc"]::after {
            content: ' ↑';
        }

        .sort-btn.active[data-dir="desc"]::after {
            content: ' ↓';
        }

        .btn-sm {
            padding: 0.45rem 0.7rem;
            font-size: 0.78rem;
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
        }

        .filter-bar {
            max-width: 260px;
            margin-bottom: 1rem;
        }

        .filter-bar select {
            width: 100%;
            border: 1px solid var(--border-strong);
            background: var(--bg-card);
            color: var(--text-primary);
            border-radius: var(--radius-sm);
            padding: 0.55rem 0.7rem;
        }

        .text-center {
            text-align: center;
        }

        .team-cell {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .team-players {
            font-weight: 500;
        }

        .score-cell.score-winner {
            color: var(--accent);
        }

        .score-cell.score-loser {
            color: var(--text-muted);
        }

        .winner-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            border-radius: 999px;
            padding: 0.2rem 0.55rem;
            background: var(--accent-muted);
            color: var(--accent);
            font-size: 0.75rem;
            font-weight: 600;
        }

        .winner-badge.tie {
            background: rgba(197, 212, 203, 0.15);
            color: var(--text-secondary);
        }

        .rounds-badge {
            display: inline-flex;
            border-radius: 999px;
            border: 1px solid var(--border);
            padding: 0.12rem 0.45rem;
            font-size: 0.74rem;
            color: var(--accent-light);
            background: rgba(201, 169, 98, 0.1);
        }

        .pagination {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 0.4rem;
            margin-top: 0.8rem;
            flex-wrap: wrap;
        }

        .pagination-label {
            color: var(--text-muted);
            font-size: 0.82rem;
        }

        .toast {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background: rgba(22, 34, 29, 0.95);
            color: var(--text-primary);
            border: 1px solid var(--border-strong);
            padding: 0.75rem 1rem;
            border-radius: var(--radius-sm);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.25s ease;
            z-index: 1200;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.55);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            z-index: 1100;
            padding: 1rem;
        }

        .modal-backdrop.show {
            opacity: 1;
            pointer-events: auto;
        }

        .modal {
            width: min(620px, 95vw);
            max-height: 92vh;
            overflow: auto;
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1.2rem;
            transform: translateY(10px);
            transition: transform 0.2s ease;
            box-shadow: 0 18px 45px rgba(0,0,0,0.35);
        }

        .modal-backdrop.show .modal {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.85rem;
        }

        .modal-title {
            font-family: 'DM Serif Display', serif;
            font-size: 1.25rem;
        }

        .modal-body {
            display: grid;
            gap: 0.65rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.28rem;
        }

        .form-group label {
            color: var(--text-secondary);
            font-size: 0.82rem;
        }

        .form-group input,
        .form-group select {
            border: 1px solid var(--border-strong);
            background: var(--bg-card);
            color: var(--text-primary);
            border-radius: var(--radius-sm);
            padding: 0.55rem 0.7rem;
        }

        .modal-actions {
            margin-top: 0.9rem;
            display: flex;
            justify-content: flex-end;
            gap: 0.4rem;
            flex-wrap: wrap;
        }

        .icon-btn {
            width: 32px;
            height: 32px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .icon-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .scores-grid {
            display: grid;
            gap: 0.6rem;
        }

        .rounds-actions {
            display: flex;
            gap: 0.4rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .rounds-row {
            display: grid;
            grid-template-columns: 85px 1fr 1fr;
            gap: 0.5rem;
            align-items: center;
        }

        .round-index {
            color: var(--accent-light);
            font-size: 0.82rem;
            font-weight: 600;
        }

        .scores-summary {
            display: grid;
            gap: 0.2rem;
            padding: 0.65rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: rgba(0, 0, 0, 0.12);
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .scores-summary strong {
            color: var(--accent-light);
        }

        .player-card-actions {
            margin-top: 0.8rem;
            padding-top: 0.7rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 0.35rem;
        }

        .helper-text {
            font-size: 0.82rem;
            color: var(--text-muted);
        }

        @media (max-width: 768px) {
            .players-toolbar {
                grid-template-columns: 1fr;
            }

            .search-bar {
                max-width: 100%;
            }

            .sort-bar {
                justify-content: flex-start;
            }

            .rounds-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="background"></div>

    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">♠</div>
                <h1>Belote Suresnes</h1>
            </div>
            <p class="subtitle">Scores, sessions et performances du club</p>
        </header>

        <div class="nav-wrapper">
            <nav>
                <a href="#joueurs" data-tab="joueurs" class="active"><span class="suit">♠</span> Joueurs</a>
                <a href="#parties" data-tab="parties"><span class="suit">♥</span> Parties</a>
                <a href="#scores" data-tab="scores"><span class="suit">♦</span> Scores</a>
                <a href="#kpi" data-tab="kpi"><span class="suit">♣</span> KPI</a>
            </nav>
        </div>

        <div class="main-content">
            <section id="joueurs" class="active">
                <div class="section-header">
                    <div class="section-title">
                        <h2><span class="suit">♠</span> Joueurs</h2>
                        <p class="section-subtitle">Les membres du club et leurs statistiques</p>
                    </div>
                    <button class="btn btn-primary" id="addPlayerBtn">+ Ajouter</button>
                </div>

                <div class="players-toolbar">
                    <div class="search-bar">
                        <input type="text" id="searchPlayers" placeholder="Rechercher un joueur...">
                    </div>
                    <div class="sort-bar" id="playersSort">
                        <button class="sort-btn" data-sort="name" data-default-dir="asc">Nom</button>
                        <button class="sort-btn" data-sort="games" data-default-dir="desc">Parties</button>
                        <button class="sort-btn" data-sort="wins" data-default-dir="desc">Victoires</button>
                        <button class="sort-btn active" data-sort="winRate" data-default-dir="desc">Taux</button>
                        <button class="sort-btn" data-sort="avgRoundPoints" data-default-dir="desc">Moyenne</button>
                    </div>
                </div>

                <div class="players-grid" id="playersBody"></div>
            </section>

            <section id="parties">
                <div class="section-header">
                    <div class="section-title">
                        <h2><span class="suit" style="color: var(--red);">♥</span> Parties</h2>
                        <p class="section-subtitle">Planifiez une partie, saisissez les manches et suivez les vainqueurs</p>
                    </div>
                    <button class="btn btn-primary" id="addMatchBtn">+ Nouvelle partie</button>
                </div>

                <div class="parties-container" id="matchesGrid"></div>

                <div class="empty-state" id="matchesEmpty" style="display: none;">
                    <div class="empty-state-icon">♣</div>
                    <div class="empty-state-text">Aucune partie planifiée pour le moment</div>
                </div>
            </section>

            <section id="scores">
                <div class="section-header">
                    <div class="section-title">
                        <h2><span class="suit" style="color: var(--red);">♦</span> Historique &amp; scores</h2>
                        <p class="section-subtitle">Toutes les parties passées et leurs résultats</p>
                    </div>
                </div>

                <div class="filter-bar">
                    <select id="playerFilter">
                        <option value="">Tous les joueurs</option>
                    </select>
                </div>

                <div class="table-wrapper">
                    <table class="scores-table" id="scoresTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Équipe A</th>
                                <th class="text-center">Score A</th>
                                <th>Équipe B</th>
                                <th class="text-center">Score B</th>
                                <th>Vainqueur</th>
                            </tr>
                        </thead>
                        <tbody id="scoresBody"></tbody>
                    </table>
                </div>

                <div class="pagination" id="scoresPagination" style="display: none;">
                    <span class="pagination-label" id="scoresPaginationLabel"></span>
                    <button class="btn btn-secondary btn-sm" id="scoresPrevBtn">Précédent</button>
                    <button class="btn btn-secondary btn-sm" id="scoresNextBtn">Suivant</button>
                </div>

                <div class="empty-state" id="scoresEmpty" style="display: none;">
                    <div class="empty-state-icon">🃏</div>
                    <div class="empty-state-text">Aucune partie trouvée pour ce joueur</div>
                </div>
            </section>

            <section id="kpi">
                <div class="section-header">
                    <div class="section-title">
                        <h2><span class="suit">♣</span> KPI &amp; performances</h2>
                        <p class="section-subtitle">Les chiffres clés et les meilleurs joueurs</p>
                    </div>
                </div>

                <div id="kpiGrid"></div>
            </section>
        </div>

        <footer>
            <div class="footer-suits"><span>♠</span><span>♥</span><span>♦</span><span>♣</span></div>
            <p>Belote Suresnes - Fait avec passion pour les amoureux de la belote</p>
        </footer>
    </div>

    <div class="toast" id="toast"></div>

    <div class="modal-backdrop" id="playerModal">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="playerModalTitle">
            <div class="modal-header">
                <div class="modal-title" id="playerModalTitle">Ajouter un joueur</div>
                <button class="icon-btn" id="closeModalBtn" aria-label="Fermer">✕</button>
            </div>
            <form id="playerForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="firstName">Prénom *</label>
                        <input type="text" id="firstName" name="first_name" required>
                    </div>
                    <div class="form-group">
                        <label for="lastName">Nom *</label>
                        <input type="text" id="lastName" name="last_name" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email">
                    </div>
                    <div class="form-group">
                        <label for="phone">Téléphone</label>
                        <input type="tel" id="phone" name="phone">
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelModalBtn">Annuler</button>
                    <button type="submit" class="btn btn-primary" id="savePlayerBtn">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-backdrop" id="matchModal">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="matchModalTitle">
            <div class="modal-header">
                <div class="modal-title" id="matchModalTitle">Ajouter une partie</div>
                <button class="icon-btn" id="closeMatchModalBtn" aria-label="Fermer">✕</button>
            </div>
            <form id="matchForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="matchPlayedAt">Date &amp; heure *</label>
                        <input type="datetime-local" id="matchPlayedAt" name="played_at" required>
                    </div>
                    <div class="form-group">
                        <label for="matchLocation">Lieu *</label>
                        <input type="text" id="matchLocation" name="location" required>
                    </div>
                    <div class="form-group">
                        <label for="team1Player1">Équipe 1 - Joueur 1 *</label>
                        <select id="team1Player1" class="match-player-select" required></select>
                    </div>
                    <div class="form-group">
                        <label for="team1Player2">Équipe 1 - Joueur 2 *</label>
                        <select id="team1Player2" class="match-player-select" required></select>
                    </div>
                    <div class="form-group">
                        <label for="team2Player1">Équipe 2 - Joueur 1 *</label>
                        <select id="team2Player1" class="match-player-select" required></select>
                    </div>
                    <div class="form-group">
                        <label for="team2Player2">Équipe 2 - Joueur 2 *</label>
                        <select id="team2Player2" class="match-player-select" required></select>
                    </div>
                    <div class="helper-text">Les joueurs doivent être tous différents.</div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelMatchModalBtn">Annuler</button>
                    <button type="submit" class="btn btn-primary" id="saveMatchBtn">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-backdrop" id="scoresModal">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="scoresModalTitle">
            <div class="modal-header">
                <div class="modal-title" id="scoresModalTitle">Saisir les scores</div>
                <button class="icon-btn" id="closeScoresModalBtn" aria-label="Fermer">✕</button>
            </div>
            <form id="scoresForm">
                <div class="modal-body">
                    <div class="helper-text" id="scoresTeams"></div>
                    <div class="scores-summary" id="scoresSummary" style="display: none;"></div>
                    <div class="form-group">
                        <label for="roundsCount">Nombre de manches *</label>
                        <div class="rounds-actions">
                            <input type="number" id="roundsCount" min="1" value="1">
                            <button type="button" class="btn btn-secondary btn-sm" id="addRoundBtn">+ Manche</button>
                            <button type="button" class="btn btn-secondary btn-sm" id="removeRoundBtn">- Manche</button>
                        </div>
                    </div>
                    <div class="scores-grid" id="roundsContainer"></div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelScoresModalBtn">Annuler</button>
                    <button type="submit" class="btn btn-primary" id="saveScoresBtn">Enregistrer les scores</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ==========================================================================
        // DONNÃ‰ES & API
        // ==========================================================================

        const API_BASE = 'https://belote-i4ac.onrender.com/api/players';
        const PLAYER_STATS_API_BASE = 'https://belote-i4ac.onrender.com/api/players/stats';
        const MATCHES_API_BASE = 'https://belote-i4ac.onrender.com/api/matches';
        const KPI_API_BASE = 'https://belote-i4ac.onrender.com/api/kpis';
        let players = [];
        let playersStats = [];
        let matches = [];
        let scoresState = {
            items: [],
            limit: 10,
            offset: 0,
            total: 0,
            filterPlayerId: null
        };

        let kpiState = {
            totals: null,
            matchesByMonth: [],
            topWinners: [],
            topScorer: null
        };
        const SUITS = ['♠', '♥', '♦', '♣'];

        // ==========================================================================
        // FONCTIONS UTILITAIRES
        // ==========================================================================

        function switchTab(tabId) {
            const fallback = 'joueurs';
            const resolvedTab = document.getElementById(tabId) ? tabId : fallback;

            document.querySelectorAll('nav a[data-tab]').forEach((link) => {
                link.classList.toggle('active', link.dataset.tab === resolvedTab);
            });

            document.querySelectorAll('.main-content section').forEach((section) => {
                section.classList.toggle('active', section.id === resolvedTab);
            });
        }

        function setupTabs() {
            document.querySelectorAll('nav a[data-tab]').forEach((link) => {
                link.addEventListener('click', (event) => {
                    event.preventDefault();
                    const tabId = link.dataset.tab;
                    switchTab(tabId);
                    history.pushState(null, '', `#${tabId}`);
                });
            });

            const initialTab = window.location.hash ? window.location.hash.substring(1) : 'joueurs';
            switchTab(initialTab);

            window.addEventListener('popstate', () => {
                const tabId = window.location.hash ? window.location.hash.substring(1) : 'joueurs';
                switchTab(tabId);
            });
        }

        /**
         * RÃ©cupÃ¨re un joueur par son ID
         */
        function getPlayerById(id) {
            return players.find(p => p.id === id) || { id, name: `Joueur #${id}` };
        }

        /**
         * Retourne le nom d'affichage d'un joueur (pseudo si disponible, sinon prÃ©nom)
         */
        function getDisplayName(player) {
            if (!player) return 'Joueur inconnu';
            if (player.pseudo) return player.pseudo;
            if (player.name) return player.name.split(' ')[0];
            if (player.first_name || player.last_name) {
                return `${player.first_name || ''} ${player.last_name || ''}`.trim();
            }
            return `Joueur #${player.id}`;
        }

        /**
         * Formate une date au format franÃ§ais
         */
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const options = { weekday: 'long', day: 'numeric', month: 'long' };
            return date.toLocaleDateString('fr-FR', options);
        }

        /**
         * Formate une date courte
         */
        function formatDateShort(dateStr) {
            const date = new Date(dateStr);
            const options = { day: 'numeric', month: 'short', year: 'numeric' };
            return date.toLocaleDateString('fr-FR', options);
        }

        function formatDateTime(dateStr) {
            const date = new Date(dateStr);
            const options = { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' };
            return date.toLocaleDateString('fr-FR', options);
        }

        function toLocalInputValue(dateStr) {
            const date = dateStr ? new Date(dateStr) : new Date();
            const tzOffset = date.getTimezoneOffset() * 60000;
            return new Date(date.getTime() - tzOffset).toISOString().slice(0, 16);
        }

        function getInitials(player) {
            const first = (player?.first_name || player?.name || '').trim();
            const last = (player?.last_name || '').trim();

            if (first && last) {
                return `${first[0]}${last[0]}`.toUpperCase();
            }

            const parts = first.split(' ').filter(Boolean);
            if (parts.length >= 2) {
                return `${parts[0][0]}${parts[1][0]}`.toUpperCase();
            }

            return (first.slice(0, 2) || '??').toUpperCase();
        }

        function formatMonthLabel(monthValue) {
            if (!monthValue) return '-';
            if (/^\d{4}-\d{2}$/.test(String(monthValue))) {
                const date = new Date(`${monthValue}-01T00:00:00`);
                if (!Number.isNaN(date.getTime())) {
                    return date.toLocaleDateString('fr-FR', { month: 'short' });
                }
            }
            return String(monthValue).slice(0, 3);
        }

        function computeCapots() {
            return matches.reduce((count, match) => {
                const rounds = Array.isArray(match.rounds) ? match.rounds : [];
                if (!rounds.length) return count;
                const won = countRoundsWon(rounds);
                return won.team1 === 0 || won.team2 === 0 ? count + 1 : count;
            }, 0);
        }

        async function fetchPlayersStats(query = '') {
            const params = new URLSearchParams();
            if (query) {
                params.set('q', query);
            }
            const url = params.toString() ? `${PLAYER_STATS_API_BASE}?${params.toString()}` : PLAYER_STATS_API_BASE;
            const response = await fetch(url);
            const payload = await response.json();

            if (!response.ok || !payload.success) {
                const message = payload?.error?.message || 'Erreur lors du chargement des statistiques joueurs.';
                throw new Error(message);
            }

            playersStats = (payload.data?.items || []).map((item) => {
                const normalized = normalizePlayer(item);
                const stats = item?.stats || {};
                return {
                    ...normalized,
                    games: Number(stats.playedMatches) || 0,
                    wins: Number(stats.wins) || 0,
                    winRate: Number(stats.winRate) || 0,
                    avgRoundPoints: stats.avgRoundPoints === null || stats.avgRoundPoints === undefined
                        ? null
                        : Number(stats.avgRoundPoints),
                    recentForm: {
                        results: Array.isArray(stats.recentForm) ? stats.recentForm : [],
                        wins: Array.isArray(stats.recentForm) ? stats.recentForm.filter(r => r === 'W').length : 0,
                        losses: Array.isArray(stats.recentForm) ? stats.recentForm.filter(r => r === 'L').length : 0
                    }
                };
            });
        }

        /**
         * Retourne la classe CSS pour le taux de victoire
         */
        function getWinRateClass(rate) {
            if (rate >= 60) return 'win-rate-high';
            if (rate >= 40) return 'win-rate-medium';
            return 'win-rate-low';
        }

        /**
         * Affiche une notification toast
         */
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function normalizePlayer(row) {
            return {
                ...row,
                name: `${row.first_name} ${row.last_name}`.trim(),
                pseudo: null
            };
        }

        async function fetchPlayers() {
            const response = await fetch(API_BASE);
            const payload = await response.json();

            if (!response.ok || !payload.success) {
                const message = payload?.error?.message || 'Erreur lors du chargement des joueurs.';
                throw new Error(message);
            }

            players = payload.data.map(normalizePlayer);
        }

        async function savePlayer(payload, playerId = null) {
            const method = playerId ? 'PUT' : 'POST';
            const url = playerId ? `${API_BASE}/${playerId}` : API_BASE;

            const response = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await response.json();
            if (!response.ok || !data.success) {
                const message = data?.error?.message || "Erreur lors de l'enregistrement.";
                throw new Error(message);
            }
        }

        async function deletePlayer(playerId) {
            const response = await fetch(`${API_BASE}/${playerId}`, { method: 'DELETE' });
            const data = await response.json();
            if (!response.ok || !data.success) {
                const message = data?.error?.message || 'Erreur lors de la suppression.';
                throw new Error(message);
            }
        }

        async function fetchMatches() {
            const response = await fetch(MATCHES_API_BASE);
            const payload = await response.json();

            if (!response.ok || !payload.success) {
                const message = payload?.error?.message || 'Erreur lors du chargement des parties.';
                throw new Error(message);
            }

            matches = payload.data;
        }

        async function fetchMatchDetails(matchId) {
            const response = await fetch(`${MATCHES_API_BASE}/${matchId}`);
            const payload = await response.json();

            if (!response.ok || !payload.success) {
                const message = payload?.error?.message || 'Erreur lors du chargement de la partie.';
                throw new Error(message);
            }

            return payload.data;
        }

        async function fetchPlayedMatches({ limit = 10, offset = 0, playerId = null } = {}) {
            const params = new URLSearchParams();
            params.set('limit', String(limit));
            params.set('offset', String(offset));
            if (playerId) {
                params.set('player_id', String(playerId));
            }

            const response = await fetch(`${MATCHES_API_BASE}/played?${params.toString()}`);
            const payload = await response.json();

            if (!response.ok || !payload.success) {
                const message = payload?.error?.message || 'Erreur lors du chargement des parties jouees.';
                throw new Error(message);
            }

            return payload.data;
        }

        async function fetchKpis() {
            const response = await fetch(KPI_API_BASE);
            const payload = await response.json();

            if (!response.ok || !payload.success) {
                const message = payload?.error?.message || 'Erreur lors du chargement des KPIs.';
                throw new Error(message);
            }

            return payload.data;
        }

        async function saveMatch(payload, matchId = null) {
            const method = matchId ? 'PUT' : 'POST';
            const url = matchId ? `${MATCHES_API_BASE}/${matchId}` : MATCHES_API_BASE;

            const response = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await response.json();
            if (!response.ok || !data.success) {
                const message = data?.error?.message || "Erreur lors de l'enregistrement de la partie.";
                throw new Error(message);
            }
        }

        async function deleteMatch(matchId) {
            const response = await fetch(`${MATCHES_API_BASE}/${matchId}`, { method: 'DELETE' });
            const data = await response.json();
            if (!response.ok || !data.success) {
                const message = data?.error?.message || 'Erreur lors de la suppression.';
                throw new Error(message);
            }
        }

        async function saveMatchRounds(matchId, rounds) {
            const response = await fetch(`${MATCHES_API_BASE}/${matchId}/rounds`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ rounds })
            });
            const data = await response.json();
            if (!response.ok || !data.success) {
                const message = data?.error?.message || 'Erreur lors de la sauvegarde des scores.';
                throw new Error(message);
            }
        }

        // ==========================================================================
        // RENDU DES SECTIONS
        // ==========================================================================

        /**
         * Render les joueurs sous forme de cartes
         */
        function renderPlayersTable(filter = '', sortKey = 'winRate', sortDir = 'desc') {
            const grid = document.getElementById('playersBody');

            let playersWithStats = [...playersStats];

            if (filter) {
                const lowerFilter = filter.toLowerCase();
                playersWithStats = playersWithStats.filter((player) =>
                    player.name.toLowerCase().includes(lowerFilter) ||
                    (player.pseudo && player.pseudo.toLowerCase().includes(lowerFilter))
                );
            }

            const normalizeNumber = (value) => (Number.isFinite(value) ? value : 0);
            const getSortValue = (item) => {
                switch (sortKey) {
                case 'name':
                    return item.name.toLowerCase();
                case 'games':
                    return normalizeNumber(item.games);
                case 'wins':
                    return normalizeNumber(item.wins);
                case 'winRate':
                    return normalizeNumber(item.winRate);
                case 'avgRoundPoints':
                    return item.avgRoundPoints === null ? -1 : normalizeNumber(item.avgRoundPoints);
                case 'recentForm':
                    return normalizeNumber(item.recentForm?.wins || 0);
                default:
                    return normalizeNumber(item[sortKey]);
                }
            };

            playersWithStats.sort((a, b) => {
                const valA = getSortValue(a);
                const valB = getSortValue(b);
                if (valA === valB) {
                    return a.name.localeCompare(b.name);
                }
                return sortDir === 'asc' ? (valA > valB ? 1 : -1) : (valA < valB ? 1 : -1);
            });

            if (!playersWithStats.length) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="empty-state-icon">♠</div>
                        <div class="empty-state-text">Aucun joueur pour le moment.</div>
                    </div>
                `;
                return;
            }

            grid.innerHTML = playersWithStats.map((player, index) => {
                const suit = SUITS[index % SUITS.length];
                const recent = (player.recentForm?.results || []).slice(0, 5);
                const dots = `
                    ${recent.map((result) => `<span class="form-dot ${result === 'W' ? 'win' : 'loss'}"></span>`).join('')}
                    ${Array.from({ length: Math.max(0, 5 - recent.length) }).map(() => '<span class="form-dot empty"></span>').join('')}
                `;

                return `
                    <article class="player-card" data-player-id="${player.id}" data-suit="${suit}">
                        <div class="player-top">
                            <div class="player-avatar">${getInitials(player)}</div>
                            <div class="player-info">
                                <div class="player-name">${player.name}</div>
                                <div class="player-form">${dots}</div>
                            </div>
                        </div>
                        <div class="player-stats">
                            <div class="stat">
                                <div class="stat-value">${player.games ?? 0}</div>
                                <div class="stat-label">Parties</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">${player.wins ?? 0}</div>
                                <div class="stat-label">Victoires</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value highlight">${player.winRate ?? 0}%</div>
                                <div class="stat-label">Taux</div>
                            </div>
                        </div>
                        <div class="player-card-actions">
                            <button class="icon-btn" data-action="edit" title="Modifier">✎</button>
                            <button class="icon-btn" data-action="delete" title="Supprimer">🗑</button>
                        </div>
                    </article>
                `;
            }).join('');
        }

        function buildMatchWhatsAppMessage(match) {
            const team1Label = getMatchTeamLabel(match.team1);
            const team2Label = getMatchTeamLabel(match.team2);
            const isPlayed = match.status === 'played' || match.rounds_played > 0;

            return `Belote Suresnes

Date: ${formatDateTime(match.played_at)}
Lieu: ${match.location}
Equipe 1: ${team1Label}
Equipe 2: ${team2Label}
Statut: ${isPlayed ? 'Jouee' : 'Planifiee'}`;
        }

        /**
         * Render la table des scores
         */
        function renderScoresTable(filterPlayerId = null) {
            const tbody = document.getElementById('scoresBody');
            const emptyState = document.getElementById('scoresEmpty');
            const tableWrapper = tbody.closest('.table-wrapper');

            const sessions = scoresState.items || [];

            if (sessions.length === 0) {
                tableWrapper.style.display = 'none';
                emptyState.style.display = 'block';
                updateScoresPagination();
                return;
            }

            tableWrapper.style.display = 'block';
            emptyState.style.display = 'none';

            tbody.innerHTML = sessions.map(session => {
                const teamANames = `${getDisplayName(session.teamA.p1)} & ${getDisplayName(session.teamA.p2)}`;
                const teamBNames = `${getDisplayName(session.teamB.p1)} & ${getDisplayName(session.teamB.p2)}`;
                const teamARounds = Number(session.rounds?.wonA) || 0;
                const teamBRounds = Number(session.rounds?.wonB) || 0;
                const isTie = teamARounds === teamBRounds;
                const teamAWins = teamARounds > teamBRounds;
                const winnerNames = isTie ? 'Egalite' : (teamAWins ? teamANames : teamBNames);
                const roundSummary = `${teamARounds} - ${teamBRounds}`;

                return `
                    <tr>
                        <td>${formatDateShort(session.played_at)}</td>
                        <td>
                            <div class="team-cell">
                                <span class="team-players">${teamANames}</span>
                            </div>
                        </td>
                        <td class="text-center">
                            <span class="score-cell ${isTie ? '' : (teamAWins ? 'score-winner' : 'score-loser')}">${session.totals?.scoreA ?? 0}</span>
                        </td>
                        <td>
                            <div class="team-cell">
                                <span class="team-players">${teamBNames}</span>
                            </div>
                        </td>
                        <td class="text-center">
                            <span class="score-cell ${isTie ? '' : (!teamAWins ? 'score-winner' : 'score-loser')}">${session.totals?.scoreB ?? 0}</span>
                        </td>
                        <td>
                            <span class="winner-badge ${isTie ? 'tie' : ''}">🏆 ${winnerNames}</span>
                            <div class="helper-text">Manches : <span class="rounds-badge">${roundSummary}</span></div>
                        </td>
                    </tr>
                `;
            }).join('');
            updateScoresPagination();
        }

        function updateScoresPagination() {
            const pagination = document.getElementById('scoresPagination');
            const label = document.getElementById('scoresPaginationLabel');
            const prevBtn = document.getElementById('scoresPrevBtn');
            const nextBtn = document.getElementById('scoresNextBtn');

            if (!pagination) return;

            const { limit, offset, total } = scoresState;
            const start = total === 0 ? 0 : offset + 1;
            const end = Math.min(offset + limit, total);

            if (total <= limit) {
                pagination.style.display = 'none';
                return;
            }

            pagination.style.display = 'flex';
            label.textContent = `Affichage ${start}-${end} sur ${total}`;
            prevBtn.disabled = offset <= 0;
            nextBtn.disabled = offset + limit >= total;
        }

        async function loadScores() {
            try {
                const data = await fetchPlayedMatches({
                    limit: scoresState.limit,
                    offset: scoresState.offset,
                    playerId: scoresState.filterPlayerId
                });
                scoresState.items = data.items;
                scoresState.total = data.pagination?.total ?? 0;
                scoresState.limit = data.pagination?.limit ?? scoresState.limit;
                scoresState.offset = data.pagination?.offset ?? scoresState.offset;
                renderScoresTable(scoresState.filterPlayerId);
            } catch (error) {
                showToast(error.message || 'Impossible de charger les scores.');
            }
        }

        /**
         * Remplit le dropdown de filtre des joueurs
         */
        function populatePlayerFilter() {
            const select = document.getElementById('playerFilter');
            const sortedPlayers = [...players].sort((a, b) => a.name.localeCompare(b.name));

            while (select.options.length > 1) {
                select.remove(1);
            }

            sortedPlayers.forEach(player => {
                const option = document.createElement('option');
                option.value = player.id;
                option.textContent = `${player.name}${player.pseudo ? ` (${player.pseudo})` : ''}`;
                select.appendChild(option);
            });
        }

        /**
         * Render les KPIs
         */
        function renderKPIs() {
            const grid = document.getElementById('kpiGrid');

            if (!kpiState?.totals) {
                grid.innerHTML = `
                    <div class="kpi-card">
                        <span class="suit-watermark">♠</span>
                        <div class="kpi-value">—</div>
                        <div class="kpi-label">Chargement des KPIs...</div>
                    </div>
                `;
                return;
            }

            const totals = kpiState.totals || {};
            const matchesByMonth = Array.isArray(kpiState.matchesByMonth) ? kpiState.matchesByMonth : [];
            const topWinners = Array.isArray(kpiState.topWinners) ? kpiState.topWinners : [];
            const topScorer = kpiState.topScorer || null;
            const avgScore = totals.matches ? Math.round((totals.points || 0) / totals.matches) : 0;
            const capots = totals.capots ?? computeCapots();
            const maxMatches = Math.max(...matchesByMonth.map(item => Number(item.total_matches) || 0), 0);

            const first = topWinners[0] || null;
            const second = topWinners[1] || null;
            const third = topWinners[2] || null;

            const podiumPlace = (entry, rankClass, medal, fallbackLabel) => {
                if (!entry) {
                    return `
                        <div class="podium-place ${rankClass}">
                            <div class="podium-avatar">--</div>
                            <div class="podium-name">${fallbackLabel}</div>
                            <div class="podium-stat">0 victoire</div>
                            <div class="podium-bar"><span class="podium-rank">${medal}</span></div>
                        </div>
                    `;
                }

                return `
                    <div class="podium-place ${rankClass}">
                        <div class="podium-avatar">${getInitials(entry.player)}</div>
                        <div class="podium-name">${getDisplayName(entry.player)}</div>
                        <div class="podium-stat">${entry.wins || 0} victoire${(entry.wins || 0) > 1 ? 's' : ''}</div>
                        <div class="podium-bar"><span class="podium-rank">${medal}</span></div>
                    </div>
                `;
            };

            const bestScoreCard = topScorer
                ? `
                    <div class="best-score-card">
                        <div class="best-score-icon">🎯</div>
                        <div class="best-score-info">
                            <div class="best-score-label">Record du club</div>
                            <div class="best-score-value">${topScorer.points || 0} pts</div>
                            <div class="best-score-player">${topScorer.player?.first_name || ''} ${topScorer.player?.last_name || ''}</div>
                        </div>
                    </div>
                `
                : `
                    <div class="best-score-card">
                        <div class="best-score-icon">🎯</div>
                        <div class="best-score-info">
                            <div class="best-score-label">Record du club</div>
                            <div class="best-score-value">0 pts</div>
                            <div class="best-score-player">Aucun score enregistré</div>
                        </div>
                    </div>
                `;

            const monthBars = matchesByMonth.length
                ? matchesByMonth.map((item) => {
                    const totalMatches = Number(item.total_matches) || 0;
                    const height = maxMatches > 0 ? Math.max(8, Math.round((totalMatches / maxMatches) * 100)) : 8;
                    return `
                        <div class="bar-item">
                            <div class="bar" style="height: ${height}%;">
                                <span class="bar-value">${totalMatches}</span>
                            </div>
                            <span class="bar-label">${formatMonthLabel(item.month)}</span>
                        </div>
                    `;
                }).join('')
                : '<div class="bar-item" style="flex: 1 1 100%;"><span class="bar-label">Aucune donnée mensuelle</span></div>';

            grid.innerHTML = `
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <span class="suit-watermark">♠</span>
                        <div class="kpi-value">${totals.matches || 0}</div>
                        <div class="kpi-label">Parties jouées</div>
                    </div>
                    <div class="kpi-card">
                        <span class="suit-watermark">♥</span>
                        <div class="kpi-value">${totals.players || 0}</div>
                        <div class="kpi-label">Joueurs actifs</div>
                    </div>
                    <div class="kpi-card">
                        <span class="suit-watermark">♦</span>
                        <div class="kpi-value">${avgScore}</div>
                        <div class="kpi-label">Score moyen</div>
                    </div>
                    <div class="kpi-card">
                        <span class="suit-watermark">♣</span>
                        <div class="kpi-value">${capots}</div>
                        <div class="kpi-label">Capots</div>
                    </div>
                </div>

                <h3 class="kpi-section-title">🏆 Top 3 joueurs (victoires)</h3>
                <div class="podium">
                    ${podiumPlace(second, 'second', '🥈', '2e')}
                    ${podiumPlace(first, 'first', '🥇', '1er')}
                    ${podiumPlace(third, 'third', '🥉', '3e')}
                </div>

                <h3 class="kpi-section-title">⭐ Meilleur score cumulé</h3>
                ${bestScoreCard}

                <h3 class="kpi-section-title">📊 Parties jouées par mois</h3>
                <div class="chart-container">
                    <div class="bar-chart">${monthBars}</div>
                </div>
            `;
        }

        async function loadKpis() {
            try {
                const data = await fetchKpis();
                kpiState = data;
                renderKPIs();
            } catch (error) {
                const grid = document.getElementById('kpiGrid');
                grid.innerHTML = `
                    <div class="kpi-card">
                        <span class="suit-watermark">♣</span>
                        <div class="kpi-value">—</div>
                        <div class="kpi-label">${error.message || 'Impossible de charger les KPIs.'}</div>
                    </div>
                `;
            }
        }

        function getMatchTeamLabel(team) {
            return `${team.p1.name} & ${team.p2.name}`;
        }

        function summarizeRounds(rounds = []) {
            return rounds.reduce((acc, round) => {
                acc.team1 += Number(round.team1_score) || 0;
                acc.team2 += Number(round.team2_score) || 0;
                if ((Number(round.team1_score) || 0) > (Number(round.team2_score) || 0)) {
                    acc.team1Rounds += 1;
                } else if ((Number(round.team2_score) || 0) > (Number(round.team1_score) || 0)) {
                    acc.team2Rounds += 1;
                }
                return acc;
            }, { team1: 0, team2: 0, team1Rounds: 0, team2Rounds: 0 });
        }

        function countRoundsWon(rounds = []) {
            let team1 = 0;
            let team2 = 0;
            rounds.forEach((round) => {
                const team1Score = Number(round.team1_score) || 0;
                const team2Score = Number(round.team2_score) || 0;
                if (team1Score > team2Score) team1 += 1;
                else if (team2Score > team1Score) team2 += 1;
            });
            return { team1, team2 };
        }

        function getWinnerLabelFromTotals(totals, team1Label, team2Label) {
            if (!totals) return 'A definir';
            if (totals.team1 > totals.team2) return team1Label;
            if (totals.team2 > totals.team1) return team2Label;
            return 'Egalite';
        }

        function updateScoresSummary(totals, team1Label, team2Label) {
            const summary = document.getElementById('scoresSummary');
            if (!summary || !totals) return;
            const winnerLabel = getWinnerLabelFromTotals(totals, team1Label, team2Label);
            summary.style.display = 'grid';
            summary.innerHTML = `
                <div><strong>Vainqueurs :</strong> ${winnerLabel}</div>
                <div><strong>Score cumule :</strong> ${totals.team1} - ${totals.team2}</div>
                <div><strong>Manches gagnees :</strong> Equipe 1 ${totals.team1Rounds} • Equipe 2 ${totals.team2Rounds}</div>
            `;
        }

        function renderMatches() {
            const grid = document.getElementById('matchesGrid');
            const emptyState = document.getElementById('matchesEmpty');

            if (!matches.length) {
                grid.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            grid.innerHTML = matches.map(match => {
                const rounds = Array.isArray(match.rounds) ? match.rounds : [];
                const totals = summarizeRounds(rounds);
                const roundsWon = countRoundsWon(rounds);
                const roundsPlayed = rounds.length || Number(match.rounds_played) || 0;
                const isFinished = match.status === 'played';
                const isLive = !isFinished && roundsPlayed > 0;
                const statusClass = isFinished ? 'status-terminee' : (isLive ? 'status-en-cours' : 'status-planifiee');
                const statusLabel = isFinished ? 'Terminée' : (isLive ? '● En cours' : 'Planifiée');

                const roundVisuals = rounds.length
                    ? rounds.map((round) => {
                        const team1Score = Number(round.team1_score) || 0;
                        const team2Score = Number(round.team2_score) || 0;
                        if (team1Score > team2Score) return '<span class="manche-dot team-a"></span>';
                        if (team2Score > team1Score) return '<span class="manche-dot team-b"></span>';
                        return '<span class="manche-dot"></span>';
                    }).join('')
                    : '<span class="manche-dot"></span>';

                return `
                    <div class="partie-card ${isLive ? 'live' : ''}" data-match-id="${match.id}">
                        <div class="partie-header">
                            <div class="partie-meta">
                                <span class="partie-date">${formatDateTime(match.played_at)}</span>
                                <span class="partie-lieu">📍 ${match.location}</span>
                            </div>
                            <span class="partie-status ${statusClass}">${statusLabel}</span>
                        </div>
                        <div class="partie-body">
                            <div class="partie-teams">
                                <div class="team">
                                    <span class="team-label">Équipe A</span>
                                    <div class="team-players">
                                        <div class="team-player-avatar">${getInitials(match.team1.p1)}</div>
                                        <div class="team-player-avatar">${getInitials(match.team1.p2)}</div>
                                    </div>
                                    <div class="team-names">${getDisplayName(match.team1.p1)} & ${getDisplayName(match.team1.p2)}</div>
                                </div>
                                <div class="vs-container">
                                    <div class="rounds-score">
                                        <div class="round-score ${roundsWon.team1 > roundsWon.team2 ? 'winning' : ''} ${roundsPlayed === 0 ? 'muted' : ''}">${roundsPlayed === 0 ? '–' : roundsWon.team1}</div>
                                        <span class="rounds-separator">–</span>
                                        <div class="round-score ${roundsWon.team2 > roundsWon.team1 ? 'winning' : ''} ${roundsPlayed === 0 ? 'muted' : ''}">${roundsPlayed === 0 ? '–' : roundsWon.team2}</div>
                                    </div>
                                    <span class="vs-label">Manches gagnées</span>
                                    <div class="total-points">Points : <span>${totals.team1}</span> – <span>${totals.team2}</span></div>
                                </div>
                                <div class="team right">
                                    <span class="team-label">Équipe B</span>
                                    <div class="team-players">
                                        <div class="team-player-avatar">${getInitials(match.team2.p1)}</div>
                                        <div class="team-player-avatar">${getInitials(match.team2.p2)}</div>
                                    </div>
                                    <div class="team-names">${getDisplayName(match.team2.p1)} & ${getDisplayName(match.team2.p2)}</div>
                                </div>
                            </div>
                        </div>
                        <div class="partie-footer">
                            <div class="manches-info">
                                <span>${roundsPlayed} manches jouées</span>
                                <div class="manches-dots">${roundVisuals}</div>
                            </div>
                            <div class="partie-actions">
                                <button class="btn btn-secondary btn-sm" data-action="edit-match">Modifier</button>
                                <button class="btn btn-secondary btn-sm" data-action="delete-match">Supprimer</button>
                                <button class="btn btn-primary btn-sm" data-action="scores-match">Saisir scores</button>
                                <button class="btn btn-secondary btn-sm" data-action="copy-match">Copier</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ==========================================================================
        // EVENT LISTENERS & INITIALISATION
        // ==========================================================================

        // Ã‰tat du tri
        let currentSort = { key: 'winRate', dir: 'desc' };

        /**
         * Gestion du tri des colonnes
         */
        function setupTableSort() {
            const buttons = document.querySelectorAll('#playersSort .sort-btn[data-sort]');
            if (!buttons.length) return;

            const refreshButtons = () => {
                buttons.forEach((btn) => {
                    const isActive = btn.dataset.sort === currentSort.key;
                    btn.classList.toggle('active', isActive);
                    if (isActive) btn.dataset.dir = currentSort.dir;
                    else delete btn.dataset.dir;
                });
            };

            buttons.forEach((btn) => {
                btn.addEventListener('click', () => {
                    const key = btn.dataset.sort;
                    const defaultDir = btn.dataset.defaultDir || 'desc';

                    if (currentSort.key === key) {
                        currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort.key = key;
                        currentSort.dir = defaultDir;
                    }

                    refreshButtons();
                    const filter = document.getElementById('searchPlayers').value;
                    renderPlayersTable(filter, currentSort.key, currentSort.dir);
                });
            });

            refreshButtons();
        }

        /**
         * Gestion de la recherche de joueurs
         */
        function setupSearch() {
            const searchInput = document.getElementById('searchPlayers');

            searchInput.addEventListener('input', (e) => {
                const value = e.target.value;
                fetchPlayersStats(value)
                    .then(() => renderPlayersTable(value, currentSort.key, currentSort.dir))
                    .catch((error) => {
                        showToast(error.message || 'Impossible de charger les statistiques joueurs.');
                    });
            });
        }

        /**
         * Gestion du filtre par joueur dans les scores
         */
        function setupPlayerFilter() {
            const select = document.getElementById('playerFilter');

            select.addEventListener('change', (e) => {
                const playerId = e.target.value ? parseInt(e.target.value) : null;
                scoresState.filterPlayerId = playerId;
                scoresState.offset = 0;
                loadScores();
            });
        }

        function setupScoresPagination() {
            const prevBtn = document.getElementById('scoresPrevBtn');
            const nextBtn = document.getElementById('scoresNextBtn');

            if (!prevBtn || !nextBtn) return;

            prevBtn.addEventListener('click', () => {
                scoresState.offset = Math.max(0, scoresState.offset - scoresState.limit);
                loadScores();
            });

            nextBtn.addEventListener('click', () => {
                const nextOffset = scoresState.offset + scoresState.limit;
                if (nextOffset < scoresState.total) {
                    scoresState.offset = nextOffset;
                    loadScores();
                }
            });
        }

        function setupPlayerActions() {
            const grid = document.getElementById('playersBody');

            grid.addEventListener('click', (event) => {
                const editBtn = event.target.closest('[data-action="edit"]');
                const deleteBtn = event.target.closest('[data-action="delete"]');
                const card = event.target.closest('.player-card[data-player-id]');

                if (!card) return;

                if (editBtn) {
                    event.stopPropagation();
                    const playerId = Number(card.dataset.playerId);
                    const player = players.find(p => p.id === playerId);
                    if (player) openPlayerModal('edit', player);
                    return;
                }

                if (deleteBtn) {
                    event.stopPropagation();
                    const playerId = Number(card.dataset.playerId);
                    handleDeletePlayer(playerId);
                    return;
                }

                const playerId = Number(card.dataset.playerId);
                const player = players.find(p => p.id === playerId);
                if (player) openPlayerModal('edit', player);
            });
        }

        function setupModal() {
            const modal = document.getElementById('playerModal');
            const closeBtn = document.getElementById('closeModalBtn');
            const cancelBtn = document.getElementById('cancelModalBtn');
            const form = document.getElementById('playerForm');

            function closeModal() {
                modal.classList.remove('show');
                form.reset();
                form.dataset.mode = '';
                form.dataset.playerId = '';
            }

            window.openPlayerModal = function openPlayerModal(mode, player = null) {
                const title = document.getElementById('playerModalTitle');
                const saveBtn = document.getElementById('savePlayerBtn');

                form.dataset.mode = mode;
                form.dataset.playerId = player ? player.id : '';

                title.textContent = mode === 'edit' ? 'Modifier le joueur' : 'Ajouter un joueur';
                saveBtn.textContent = mode === 'edit' ? 'Enregistrer' : 'Ajouter';

                if (player) {
                    document.getElementById('firstName').value = player.first_name || '';
                    document.getElementById('lastName').value = player.last_name || '';
                    document.getElementById('email').value = player.email || '';
                    document.getElementById('phone').value = player.phone || '';
                }

                modal.classList.add('show');
            };

            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (event) => {
                if (event.target === modal) closeModal();
            });

            form.addEventListener('submit', async (event) => {
                event.preventDefault();

                const payload = {
                    first_name: document.getElementById('firstName').value.trim(),
                    last_name: document.getElementById('lastName').value.trim(),
                    email: document.getElementById('email').value.trim(),
                    phone: document.getElementById('phone').value.trim()
                };

                if (!payload.first_name || !payload.last_name) {
                    showToast('Prenom et nom sont obligatoires.');
                    return;
                }

                if (payload.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(payload.email)) {
                    showToast("Email invalide.");
                    return;
                }

                try {
                    const mode = form.dataset.mode;
                    const playerId = form.dataset.playerId ? Number(form.dataset.playerId) : null;
                    await savePlayer(payload, mode === 'edit' ? playerId : null);
                    await loadPlayers();
                    showToast(mode === 'edit' ? 'Joueur mis a jour.' : 'Joueur cree.');
                    closeModal();
                } catch (error) {
                    showToast(error.message || 'Erreur lors de la sauvegarde.');
                }
            });
        }

        async function handleDeletePlayer(playerId) {
            const confirmed = confirm('Supprimer ce joueur ?');
            if (!confirmed) return;

            try {
                await deletePlayer(playerId);
                await loadPlayers();
                showToast('Joueur supprime.');
            } catch (error) {
                showToast(error.message || 'Erreur lors de la suppression.');
            }
        }

        async function loadPlayers() {
            try {
                await fetchPlayers();
                const filter = document.getElementById('searchPlayers').value;
                await fetchPlayersStats(filter);
                renderPlayersTable(filter, currentSort.key, currentSort.dir);
                populatePlayerFilter();
                populateMatchSelects();
            } catch (error) {
                showToast(error.message || 'Impossible de charger les joueurs.');
            }
        }

        function populateMatchSelects() {
            const selects = document.querySelectorAll('.match-player-select');
            const sortedPlayers = [...players].sort((a, b) => a.name.localeCompare(b.name));

            selects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '';
                const placeholder = document.createElement('option');
                placeholder.value = '';
                placeholder.textContent = 'Selectionner un joueur';
                placeholder.disabled = true;
                placeholder.selected = true;
                select.appendChild(placeholder);

                sortedPlayers.forEach(player => {
                    const option = document.createElement('option');
                    option.value = player.id;
                    option.textContent = `${player.name}`;
                    select.appendChild(option);
                });

                if (currentValue) {
                    select.value = currentValue;
                }
            });
        }

        async function loadMatches() {
            try {
                await fetchMatches();

                const playedMatches = matches.filter(match => Number(match.rounds_played) > 0);
                const details = await Promise.all(
                    playedMatches.map(match => fetchMatchDetails(match.id).catch(() => null))
                );

                details.forEach(detail => {
                    if (!detail) return;
                    const index = matches.findIndex(match => match.id === detail.id);
                    if (index !== -1) {
                        matches[index] = { ...matches[index], rounds: detail.rounds };
                    }
                });

                renderMatches();
            } catch (error) {
                showToast(error.message || 'Impossible de charger les parties.');
            }
        }

        function setupMatchModal() {
            const modal = document.getElementById('matchModal');
            const closeBtn = document.getElementById('closeMatchModalBtn');
            const cancelBtn = document.getElementById('cancelMatchModalBtn');
            const form = document.getElementById('matchForm');

            function closeModal() {
                modal.classList.remove('show');
                form.reset();
                form.dataset.mode = '';
                form.dataset.matchId = '';
            }

            window.openMatchModal = function openMatchModal(mode, match = null) {
                const title = document.getElementById('matchModalTitle');
                const saveBtn = document.getElementById('saveMatchBtn');

                form.dataset.mode = mode;
                form.dataset.matchId = match ? match.id : '';

                title.textContent = mode === 'edit' ? 'Modifier la partie' : 'Ajouter une partie';
                saveBtn.textContent = mode === 'edit' ? 'Enregistrer' : 'Ajouter';

                populateMatchSelects();

                if (match) {
                    document.getElementById('matchPlayedAt').value = toLocalInputValue(match.played_at);
                    document.getElementById('matchLocation').value = match.location || '';
                    document.getElementById('team1Player1').value = match.team1.p1.id;
                    document.getElementById('team1Player2').value = match.team1.p2.id;
                    document.getElementById('team2Player1').value = match.team2.p1.id;
                    document.getElementById('team2Player2').value = match.team2.p2.id;
                } else {
                    document.getElementById('matchPlayedAt').value = toLocalInputValue();
                }

                modal.classList.add('show');
            };

            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (event) => {
                if (event.target === modal) closeModal();
            });

            form.addEventListener('submit', async (event) => {
                event.preventDefault();

                const payload = {
                    played_at: document.getElementById('matchPlayedAt').value,
                    location: document.getElementById('matchLocation').value.trim(),
                    team1: {
                        p1: document.getElementById('team1Player1').value,
                        p2: document.getElementById('team1Player2').value
                    },
                    team2: {
                        p1: document.getElementById('team2Player1').value,
                        p2: document.getElementById('team2Player2').value
                    }
                };

                const allIds = [payload.team1.p1, payload.team1.p2, payload.team2.p1, payload.team2.p2];
                const uniqueIds = new Set(allIds);

                if (!payload.played_at || !payload.location) {
                    showToast('La date et le lieu sont obligatoires.');
                    return;
                }

                if (uniqueIds.size !== 4) {
                    showToast('Chaque joueur doit etre unique dans la partie.');
                    return;
                }

                try {
                    const mode = form.dataset.mode;
                    const matchId = form.dataset.matchId ? Number(form.dataset.matchId) : null;
                    await saveMatch(payload, mode === 'edit' ? matchId : null);
                    await loadMatches();
                    showToast(mode === 'edit' ? 'Partie mise a jour.' : 'Partie creee.');
                    closeModal();
                } catch (error) {
                    showToast(error.message || 'Erreur lors de la sauvegarde.');
                }
            });
        }

        function renderRoundsRows(count, existingRounds = []) {
            const container = document.getElementById('roundsContainer');
            container.innerHTML = '';

            for (let i = 1; i <= count; i += 1) {
                const existing = existingRounds.find(r => Number(r.round_index) === i) || {};
                const row = document.createElement('div');
                row.className = 'rounds-row';
                row.dataset.roundIndex = i;
                row.innerHTML = `
                    <div class="round-index">Manche ${i}</div>
                    <input type="number" min="0" value="${existing.team1_score ?? ''}" placeholder="Score equipe 1" required>
                    <input type="number" min="0" value="${existing.team2_score ?? ''}" placeholder="Score equipe 2" required>
                `;
                container.appendChild(row);
            }
        }

        function setupScoresModal() {
            const modal = document.getElementById('scoresModal');
            const closeBtn = document.getElementById('closeScoresModalBtn');
            const cancelBtn = document.getElementById('cancelScoresModalBtn');
            const form = document.getElementById('scoresForm');
            const roundsCountInput = document.getElementById('roundsCount');
            const addRoundBtn = document.getElementById('addRoundBtn');
            const removeRoundBtn = document.getElementById('removeRoundBtn');
            const teamsLabel = document.getElementById('scoresTeams');
            const summary = document.getElementById('scoresSummary');

            function closeModal() {
                modal.classList.remove('show');
                form.reset();
                form.dataset.matchId = '';
                teamsLabel.textContent = '';
                summary.style.display = 'none';
                summary.innerHTML = '';
                renderRoundsRows(1);
            }

            window.openScoresModal = function openScoresModal(match) {
                form.dataset.matchId = match.id;
                teamsLabel.textContent = `Equipe 1 : ${getMatchTeamLabel(match.team1)} | Equipe 2 : ${getMatchTeamLabel(match.team2)}`;
                roundsCountInput.value = match.rounds_played && match.rounds_played > 0 ? match.rounds_played : 1;
                renderRoundsRows(Number(roundsCountInput.value), match.rounds || []);
                if (match.rounds && match.rounds.length) {
                    const totals = summarizeRounds(match.rounds);
                    updateScoresSummary(totals, getMatchTeamLabel(match.team1), getMatchTeamLabel(match.team2));
                } else {
                    summary.style.display = 'none';
                    summary.innerHTML = '';
                }
                modal.classList.add('show');
            };

            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (event) => {
                if (event.target === modal) closeModal();
            });

            addRoundBtn.addEventListener('click', () => {
                const nextCount = Number(roundsCountInput.value) + 1;
                roundsCountInput.value = nextCount;
                renderRoundsRows(nextCount);
            });

            removeRoundBtn.addEventListener('click', () => {
                const current = Number(roundsCountInput.value) || 1;
                const nextCount = Math.max(1, current - 1);
                roundsCountInput.value = nextCount;
                renderRoundsRows(nextCount);
            });

            roundsCountInput.addEventListener('change', () => {
                const value = Math.max(1, Number(roundsCountInput.value) || 1);
                roundsCountInput.value = value;
                renderRoundsRows(value);
            });

            form.addEventListener('submit', async (event) => {
                event.preventDefault();

                const matchId = Number(form.dataset.matchId);
                const rows = Array.from(document.querySelectorAll('#roundsContainer .rounds-row'));
                const rounds = rows.map((row, index) => {
                    const inputs = row.querySelectorAll('input');
                    return {
                        round_index: index + 1,
                        team1_score: Number(inputs[0].value),
                        team2_score: Number(inputs[1].value)
                    };
                });

                if (rounds.some(round => !Number.isInteger(round.team1_score) || round.team1_score < 0 || !Number.isInteger(round.team2_score) || round.team2_score < 0)) {
                    showToast('Les scores doivent etre des entiers positifs.');
                    return;
                }

                try {
                    await saveMatchRounds(matchId, rounds);
                    const updatedMatch = await fetchMatchDetails(matchId);
                    const index = matches.findIndex(match => match.id === matchId);
                    if (index !== -1) {
                        matches[index] = { ...matches[index], ...updatedMatch };
                    }
                    if (updatedMatch.rounds && updatedMatch.rounds.length) {
                        const totals = summarizeRounds(updatedMatch.rounds);
                        updateScoresSummary(totals, getMatchTeamLabel(updatedMatch.team1), getMatchTeamLabel(updatedMatch.team2));
                    }
                    renderMatches();
                    showToast('Scores enregistres.');
                    closeModal();
                } catch (error) {
                    showToast(error.message || 'Erreur lors de la sauvegarde des scores.');
                }
            });
        }

        function setupMatchActions() {
            const grid = document.getElementById('matchesGrid');

            grid.addEventListener('click', (event) => {
                const editBtn = event.target.closest('[data-action="edit-match"]');
                const deleteBtn = event.target.closest('[data-action="delete-match"]');
                const scoresBtn = event.target.closest('[data-action="scores-match"]');
                const copyBtn = event.target.closest('[data-action="copy-match"]');
                const card = event.target.closest('[data-match-id]');

                if (!card) return;
                const matchId = Number(card.dataset.matchId);
                const match = matches.find(item => item.id === matchId);

                if (editBtn && match) {
                    openMatchModal('edit', match);
                    return;
                }

                if (deleteBtn && match) {
                    const confirmed = confirm('Supprimer cette partie ?');
                    if (!confirmed) return;
                    deleteMatch(matchId)
                        .then(() => loadMatches())
                        .then(() => showToast('Partie supprimee.'))
                        .catch(error => showToast(error.message || 'Erreur lors de la suppression.'));
                    return;
                }

                if (scoresBtn && match) {
                    openScoresModal(match);
                    return;
                }

                if (copyBtn && match) {
                    const message = buildMatchWhatsAppMessage(match);
                    navigator.clipboard.writeText(message)
                        .then(() => {
                            showToast('Message copie.');
                        })
                        .catch(() => {
                            showToast('Erreur lors de la copie');
                        });
                }
            });
        }

        /**
         * Initialisation de l'application
         */
        async function init() {
            setupTabs();
            setupTableSort();
            setupSearch();
            setupPlayerFilter();
            setupScoresPagination();
            setupPlayerActions();
            setupModal();
            setupMatchModal();
            setupScoresModal();
            setupMatchActions();

            document.getElementById('addPlayerBtn').addEventListener('click', () => {
                openPlayerModal('create');
            });

            document.getElementById('addMatchBtn').addEventListener('click', () => {
                openMatchModal('create');
            });

            await loadPlayers();
            await loadMatches();
            await loadScores();
            await loadKpis();
        }

        // Lancer l'application au chargement
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>



